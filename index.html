<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MonopolX by Mustafa Evleksiz</title>
    <meta name="theme-color" content="#FFD700">
    <link rel="manifest" href="manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(err => console.log('SW reg error:', err));
            });
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Montserrat:wght@400;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --gold: #FFD700;
            --board-bg: #C8E6C9;
            --sidebar-bg: rgba(26, 26, 46, 0.95);
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: radial-gradient(circle at center, #1a1a2e 0%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
            font-size: 0.85rem;
        }

        /* Layout */
        .game-wrapper {
            display: flex;
            width: 100vw;
            height: 100vh;
            padding: 20px;
            gap: 20px;
            align-items: stretch;
        }

        .side-panel {
            width: 300px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .center-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .game-header h1 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3.5rem;
            background: linear-gradient(to right, var(--gold), #ffdf5d, var(--gold));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            filter: drop-shadow(4px 4px 0 rgba(0, 0, 0, 0.5));
            letter-spacing: 12px;
            margin-bottom: 20px;
            text-align: center;
            text-transform: uppercase;
        }

        @keyframes glowTitle {
            from {
                filter: drop-shadow(0 0 5px var(--gold));
            }

            to {
                filter: drop-shadow(0 0 20px var(--gold));
            }
        }

        .board-container {
            position: relative;
            width: min(90vh, 90vw);
            height: min(90vh, 90vw);
            perspective: 1200px;
        }

        .board {
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(11, 1fr);
            grid-template-rows: repeat(11, 1fr);
            background: var(--board-bg);
            border: 12px solid #1a3317;
            border-radius: 15px;
            box-shadow: 0 50px 100px rgba(0, 0, 0, 0.8);
            position: relative;
            transform: rotateX(5deg);
            transition: transform 0.5s ease;
        }

        .board:hover {
            transform: rotateX(0deg);
        }


        .board-center {
            grid-column: 2 / 11;
            grid-row: 2 / 11;
            background: #D7F5D7;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .center-logo {
            font-family: 'Bebas Neue', sans-serif;
            font-size: clamp(1.3rem, 4vw, 2rem);
            color: #c41e3a;
            transform: rotate(-15deg);
        }

        .dice-container {
            display: flex;
            gap: 12px;
            margin: 12px 0;
        }

        .dice {
            width: clamp(35px, 7vw, 50px);
            height: clamp(35px, 7vw, 50px);
            background: white;
            border-radius: 8px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            padding: 6px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .dice:hover {
            transform: scale(1.1);
        }

        .dice.rolling {
            animation: rollDice 0.5s ease-out;
        }

        @keyframes rollDice {
            0% {
                transform: rotate(0deg) scale(1);
            }

            50% {
                transform: rotate(180deg) scale(1.2);
            }

            100% {
                transform: rotate(360deg) scale(1);
            }
        }

        .setup-screen {
            position: fixed;
            inset: 0;
            background: #050510;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            overflow-y: auto;
            background-image:
                radial-gradient(circle at 20% 20%, rgba(255, 215, 0, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 80% 80%, rgba(196, 30, 58, 0.1) 0%, transparent 40%);
        }

        .setup-container {
            width: min(850px, 95vw);
            display: grid;
            grid-template-columns: 1.2fr 1fr;
            gap: 20px;
            background: rgba(18, 18, 32, 0.7);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 215, 0, 0.2);
            box-shadow: 0 40px 100px rgba(0, 0, 0, 0.6);
            animation: setupIn 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        @keyframes setupIn {
            from {
                opacity: 0;
                transform: translateY(40px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .rule-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 12px 18px;
            border-radius: 12px;
            margin-bottom: 8px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: 0.3s;
        }

        .rule-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--gold);
        }

        .rule-item label {
            font-size: 0.8rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
        }

        .rule-input {
            background: none;
            border: none;
            color: var(--gold);
            font-weight: 800;
            text-align: right;
            width: 80px;
            font-family: 'Montserrat';
            outline: none;
        }

        .rule-toggle {
            width: 40px;
            height: 20px;
            background: #333;
            border-radius: 10px;
            cursor: pointer;
            position: relative;
        }

        .rule-toggle.on {
            background: var(--gold);
        }

        .rule-toggle.on::after {
            left: 22px;
        }

        .rule-toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }


        .dot {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }

        .dot.active {
            background: #c41e3a;
            /* Keeping original as the provided edit was syntactically incorrect for this line */
        }

        /* Token colors added based on instruction "Polished token colors and borders" */
        .token-red {
            background: #e53935;
            box-shadow: 0 0 10px rgba(229, 57, 53, 0.4), inset 0 0 8px rgba(255, 255, 255, 0.3);
        }

        .token-blue {
            background: #1e88e5;
            box-shadow: 0 0 10px rgba(30, 136, 229, 0.4), inset 0 0 8px rgba(255, 255, 255, 0.3);
        }

        .token-green {
            background: #43a047;
            box-shadow: 0 0 10px rgba(67, 160, 71, 0.4), inset 0 0 8px rgba(255, 255, 255, 0.3);
        }

        .token-yellow {
            background: #fbc02d;
            color: #000;
            box-shadow: 0 0 10px rgba(251, 192, 45, 0.4), inset 0 0 8px rgba(255, 255, 255, 0.3);
        }

        .square {
            background: #f8fff9;
            border: 1px solid #2d5a27;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: visible;
            cursor: pointer;
            font-size: clamp(6px, 1.2vw, 10px);
            transition: transform 0.2s, box-shadow 0.2s, background 0.3s;
        }

        .square:hover {
            z-index: 100;
            transform: scale(1.15);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .square.owned {
            background: #fff;
        }

        .square.current {
            animation: currentPulse 1.2s ease-in-out infinite;
            z-index: 10;
        }

        @keyframes currentPulse {

            0%,
            100% {
                box-shadow: 0 0 15px var(--gold);
                outline: 3px solid var(--gold);
            }

            50% {
                box-shadow: 0 0 30px var(--gold);
                outline: 5px solid var(--gold);
            }
        }

        .color-bar {
            height: 22%;
            width: 100%;
            border-bottom: 2px solid #2d5a27;
        }

        .owner-info {
            position: absolute;
            bottom: 1px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: clamp(6px, 1vw, 9px);
            font-weight: 800;
            text-transform: uppercase;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 1);
            z-index: 10;
            pointer-events: none;
        }

        .owner-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 18px;
            transition: all 0.3s;
            z-index: 5;
            opacity: 1;
            border-top: 1px solid rgba(0, 0, 0, 0.4);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .square-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2px;
            text-align: center;
            position: relative;
            z-index: 2;
        }

        .square-name {
            font-weight: 800;
            font-size: clamp(5px, 1vw, 9px);
            line-height: 1.1;
            color: #1a1a1a;
            margin-bottom: 2px;
        }

        .square-price {
            font-size: clamp(5px, 0.9vw, 8px);
            font-weight: 600;
            color: #444;
        }

        .corner {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            padding: 2px;
        }

        .corner-go {
            background: linear-gradient(135deg, #fff, #f0f0f0);
            color: #c41e3a;
        }

        .corner-jail {
            background: linear-gradient(135deg, #ff9800, #f57c00);
        }

        .corner-parking {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }

        .corner-gotojail {
            background: linear-gradient(135deg, #3f51b5, #303f9f);
            color: white;
        }

        .corner-icon {
            font-size: clamp(8px, 2vw, 16px);
        }

        .chance {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
        }

        .chest {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        }

        .tax {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
        }

        .railroad {
            background: linear-gradient(135deg, #f5f5f5, #e0e0e0);
        }

        .utility {
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
        }

        .tokens-box {
            position: absolute;
            bottom: 6%;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 2px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .token {
            width: clamp(16px, 2.5vw, 24px);
            height: clamp(16px, 2.5vw, 24px);
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(12px, 2vw, 16px);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            user-select: none;
            z-index: 5;
        }

        .active-token {
            width: clamp(20px, 3vw, 30px);
            height: clamp(20px, 3vw, 30px);
            z-index: 100;
            animation: tokenPulse 1.5s infinite ease-in-out;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
            border: 2px solid var(--gold) !important;
        }

        @keyframes tokenPulse {
            0% {
                transform: translateY(0) scale(1.05);
            }

            50% {
                transform: translateY(-3px) scale(1.15);
            }

            100% {
                transform: translateY(0) scale(1.05);
            }
        }

        .square.current-active {
            box-shadow: inset 0 0 25px var(--gold);
            border-color: var(--gold) !important;
            z-index: 5;
        }

        .token.bounce {
            animation: tokenBounce 0.4s ease;
        }

        @keyframes tokenBounce {

            0%,
            100% {
                transform: translateY(0) scale(1.1);
            }

            50% {
                transform: translateY(-20px) scale(1.3);
            }
        }

        .token.jumping {
            animation: tokenBounce 0.3s ease-in-out;
        }

        .token-red {
            background: linear-gradient(135deg, #f44336, #c62828);
        }

        .token-blue {
            background: linear-gradient(135deg, #2196f3, #1565c0);
        }

        .token-green {
            background: linear-gradient(135deg, #4caf50, #2e7d32);
        }

        .token-yellow {
            background: linear-gradient(135deg, #ffeb3b, #f9a825);
            border-color: #333;
        }

        .buildings {
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 2px;
            z-index: 20;
        }

        .house {
            width: clamp(8px, 1.5vw, 14px);
            height: clamp(8px, 1.5vw, 14px);
            background: #2e7d32;
            clip-path: polygon(50% 0%, 100% 100%, 0% 100%);
            filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.3));
            border: 1px solid #1b5e20;
        }

        .hotel {
            width: clamp(14px, 2.5vw, 22px);
            height: clamp(10px, 1.8vw, 16px);
            background: #c62828;
            border-radius: 3px;
            filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.3));
            border: 1px solid #8e0000;
        }

        .players-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px;
            width: 100%;
            max-width: 620px;
            padding: 8px;
        }

        .player-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 12px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .player-card.active {
            border-color: var(--gold);
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.4);
            background: rgba(255, 215, 0, 0.08);
        }

        .player-card.bankrupt {
            opacity: 0.35;
            filter: grayscale(1);
        }

        .player-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .player-token-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 3px solid white;
        }

        .player-name {
            font-weight: 700;
            font-size: 0.8rem;
        }

        .player-money {
            font-size: 0.9rem;
            font-weight: 800;
            color: var(--gold);
        }

        .player-money.up {
            animation: moneyUp 0.4s;
            color: #4caf50;
        }

        .player-money.down {
            animation: moneyDown 0.4s;
            color: #f44336;
        }

        @keyframes moneyUp {
            50% {
                transform: scale(1.15);
            }
        }

        @keyframes moneyDown {
            50% {
                transform: scale(0.9);
            }
        }

        .player-props {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            margin-top: 6px;
        }

        .prop-dot {
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            padding: 10px;
        }

        .controls-vertical {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
        }

        .ai-waiting-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            display: none;
        }

        .ai-waiting-overlay.active {
            display: flex;
        }

        .loading-dots:after {
            content: ' .';
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {

            0%,
            20% {
                content: ' .';
            }

            40% {
                content: ' ..';
            }

            60% {
                content: ' ...';
            }

            80%,
            100% {
                content: '';
            }
        }

        .btn {
            padding: 14px 22px;
            border: none;
            border-radius: 12px;
            font-family: var(--font-main);
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn:active {
            transform: scale(0.96);
        }

        .btn:disabled {
            opacity: 0.4;
            filter: grayscale(1);
            background: rgba(100, 100, 100, 0.2) !important;
            color: rgba(255, 255, 255, 0.5) !important;
            border: 1px solid rgba(255, 255, 255, 0.05) !important;
            box-shadow: none !important;
            cursor: not-allowed;
            animation: none !important;
            text-shadow: none;
        }

        body.theme-marble .btn:disabled,
        body.theme-parchment .btn:disabled {
            background: rgba(0, 0, 0, 0.05) !important;
            color: rgba(0, 0, 0, 0.3) !important;
            border: 1px solid rgba(0, 0, 0, 0.1) !important;
        }

        .btn-roll {
            background: linear-gradient(135deg, var(--gold), #aa8a2e);
            color: #000;
            box-shadow: 0 4px 20px rgba(212, 175, 55, 0.3);
        }

        .btn-roll:hover {
            box-shadow: 0 8px 30px rgba(212, 175, 55, 0.5);
            transform: translateY(-2px);
        }

        .btn-roll:disabled {
            opacity: 0.3;
            background: #555;
            box-shadow: none;
            cursor: not-allowed;
        }

        .btn-action {
            background: linear-gradient(135deg, #43a047, #1b5e20);
            color: white;
            box-shadow: 0 4px 15px rgba(67, 160, 71, 0.3);
            animation: actionPulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes actionPulse {

            0%,
            100% {
                box-shadow: 0 4px 15px rgba(67, 160, 71, 0.3);
                transform: scale(1);
            }

            50% {
                box-shadow: 0 4px 25px rgba(67, 160, 71, 0.6);
                transform: scale(1.02);
            }
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.08);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(5px);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--gold);
        }

        .btn-end {
            background: linear-gradient(135deg, #e53935, #b71c1c);
            color: white;
        }

        /* Rent Animation */
        .rent-money {
            position: fixed;
            z-index: 10000;
            font-size: 2rem;
            pointer-events: none;
            animation: flyMoney 1s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes flyMoney {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            100% {
                transform: scale(0.5);
                opacity: 0;
                top: var(--target-y);
                left: var(--target-x);
            }
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 15px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-radius: 15px;
            padding: 25px;
            max-width: 420px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            border: 2px solid var(--gold);
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal h2 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.7rem;
            color: var(--gold);
            margin-bottom: 15px;
            text-align: center;
        }

        .modal-details {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
        }

        .modal-details p {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.85rem;
        }

        .modal-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .card-display {
            text-align: center;
            padding: 15px;
        }

        .card-inner {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 25px;
            animation: cardFlip 0.5s ease;
        }

        @keyframes cardFlip {
            0% {
                transform: rotateY(90deg);
            }

            100% {
                transform: rotateY(0);
            }
        }

        .card-icon {
            font-size: 3.5rem;
            margin-bottom: 12px;
        }

        .card-text {
            font-size: 1rem;
            line-height: 1.5;
        }

        .game-log {
            background: rgba(0, 0, 0, 0.35);
            border-radius: 8px;
            padding: 10px;
            max-height: 100px;
            overflow-y: auto;
            width: 100%;
            max-width: 620px;
        }

        :root {
            --gold: #d4af37;
            --gold-bright: #f9e29d;
            --bg-dark: #0a0a0f;
            --deep-slate: #12141d;
            --premium-blue: #16213e;
            --panel-bg: rgba(255, 255, 255, 0.03);
            --marble-bg: #fdfdfd;
            --paper-bg: #f4e4bc;
            --font-main: 'Montserrat', sans-serif;
        }

        .setup-screen.hidden {
            display: none !important;
        }

        /* Branding Badge */
        .credit-badge {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            color: var(--gold);
            padding: 8px 18px;
            border-radius: 30px;
            font-size: 0.8rem;
            font-weight: 700;
            letter-spacing: 1px;
            border: 1px solid var(--gold);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            pointer-events: none;
        }

        .credit-badge span {
            color: white;
            margin-left: 5px;
        }

        /* Themes Contrast Fixes */
        body.theme-marble {
            --gold: #7b5b00;
            --bg-dark: #f0f0f0;
            --panel-bg: white;
        }

        body.theme-marble .board {
            background: #fff !important;
            color: #000;
            border: 20px solid #222;
            box-shadow: 0 20px 80px rgba(0, 0, 0, 0.15);
        }

        body.theme-marble .square {
            border: 1.5px solid #bbb;
        }

        body.theme-marble .square-name,
        body.theme-marble .player-name,
        body.theme-marble .modal h2 {
            color: #000 !important;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        body.theme-marble .side-panel {
            background: #ffffff !important;
            color: #000;
            border: 1px solid #ddd;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.05);
        }

        body.theme-marble .player-card {
            background: #fdfdfd;
            border: 1px solid #eee;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.02);
        }

        body.theme-marble .player-card.active {
            border: 2px solid #000;
            background: #fff;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        body.theme-marble label {
            color: #555 !important;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 1px;
        }

        body.theme-marble .btn-secondary {
            background: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
        }

        body.theme-marble .btn-secondary:hover {
            background: #e5e5e5;
        }

        body.theme-parchment {
            --gold: #5d4037;
            --bg-dark: #ccb08a;
            --panel-bg: #f4e4bc;
        }

        body.theme-parchment .board {
            border: 20px solid #3e2723;
            background: #fdf5e6 url('https://www.transparenttextures.com/patterns/old-mathematics.png') !important;
        }

        body.theme-parchment .square {
            border: 1px solid #a1887f;
        }

        body.theme-parchment .square-name,
        body.theme-parchment .player-name,
        body.theme-parchment .modal h2 {
            color: #3e2723 !important;
            font-weight: 800;
            font-family: 'Playfair Display', serif;
        }

        body.theme-parchment .side-panel {
            background: #f4e4bc !important;
            color: #3e2723;
            border: 1px solid #a1887f;
            border-radius: 4px;
            box-shadow: inset 0 0 50px rgba(93, 64, 55, 0.1);
        }

        body.theme-parchment .player-card {
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(93, 64, 55, 0.2);
        }

        body.theme-parchment .btn-secondary {
            background: #e8d5b5;
            color: #3e2723;
            border: 1px solid #8d6e63;
        }

        body.theme-premium {
            --gold: #d4af37;
            --bg-dark: #07070a;
        }

        body.theme-premium .board {
            background: #11131a;
            border: 20px solid #000;
            box-shadow: 0 40px 100px rgba(0, 0, 0, 0.9);
        }

        body.theme-premium .square-name {
            color: rgba(255, 255, 255, 0.9);
            font-weight: 600;
            font-size: 0.7rem;
        }

        body.theme-premium .side-panel {
            background: #0c0d12;
            color: #fff;
            border: 1px solid #1a1c23;
            border-radius: 24px;
        }

        body.theme-premium .player-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
        }

        body.theme-premium .player-card.active {
            border-color: var(--gold);
            background: rgba(212, 175, 55, 0.08);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        body.theme-premium .setup-container {
            background: rgba(18, 20, 29, 0.4);
        }

        body.theme-premium .board-center {
            background: rgba(18, 20, 29, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(212, 175, 55, 0.1);
        }

        body.theme-premium .square {
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        body.theme-premium .square-name {
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        body.theme-premium .side-panel {
            background: #0c0d12;
            border-color: #1a1c23;
        }

        body.theme-premium .player-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        body.theme-premium .player-card.active {
            border-color: var(--gold);
            background: rgba(212, 175, 55, 0.05);
        }

        .setup-screen {
            position: fixed;
            inset: 0;
            background: #050508;
            background-image: radial-gradient(circle at 50% 20%, #1a1c2c 0%, #050508 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
            overflow-y: auto;
        }

        .setup-container {
            background: rgba(18, 20, 29, 0.4);
            backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 40px 100px rgba(0, 0, 0, 0.6);
            padding: 40px;
            border-radius: 30px;
            max-width: 1100px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
        }

        .icon-modal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 15px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }

        .icon-category-btn {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .icon-category-btn.active {
            background: var(--gold);
            color: #000;
            border-color: var(--gold);
        }

        .token-preview {
            width: 55px !important;
            height: 55px !important;
            font-size: 1.6rem !important;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
        }

        .token-preview:hover {
            transform: scale(1.05);
            border-color: var(--gold);
            background: rgba(212, 175, 55, 0.1);
        }

        .token-preview::after {
            content: 'DEĞİŞTİR';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--gold);
            color: #000;
            font-size: 0.5rem;
            font-weight: 900;
            padding: 2px 6px;
            border-radius: 10px;
            opacity: 0;
            transition: 0.3s;
        }

        .token-preview:hover::after {
            opacity: 1;
            bottom: 2px;
        }

        .icon-opt-big {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .icon-opt-big:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
            border-color: var(--gold);
        }

        .theme-preview {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .theme-card {
            flex: 1;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .theme-card.selected {
            border-color: var(--gold);
            background: rgba(212, 175, 55, 0.1);
        }

        .theme-card div {
            height: 40px;
            border-radius: 5px;
            margin-bottom: 8px;
        }



        .theme-marble-card div {
            background: var(--marble-bg);
            border: 1px solid #ccc;
        }

        .theme-parchment-card div {
            background: var(--paper-bg);
            border: 1px solid #8d6e63;
        }

        .player-type-select {
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-family: 'Montserrat', sans-serif;
            cursor: pointer;
            width: 130px;
            outline: none;
        }

        .player-type-select:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: var(--gold);
        }

        .player-type-select option {
            background: #1a1a2e;
            color: white;
        }

        .player-input input:focus {
            border-color: var(--gold);
            outline: none;
        }

        .player-input input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .player-input .token-preview {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 3px solid white;
        }

        .auction-bid {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--gold);
            text-align: center;
            margin: 15px 0;
        }

        .auction-info {
            text-align: center;
            margin-bottom: 15px;
            color: rgba(255, 255, 255, 0.8);
        }

        .auction-players {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-bottom: 15px;
        }

        .auction-player {
            padding: 8px 15px;
            border-radius: 8px;
            border: 2px solid;
            background: rgba(255, 255, 255, 0.08);
        }

        .auction-player.current {
            background: rgba(255, 215, 0, 0.15);
            box-shadow: 0 0 12px rgba(255, 215, 0, 0.3);
        }

        .auction-player.out {
            opacity: 0.35;
        }

        .bid-btns {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .bid-btn {
            padding: 10px 18px;
            border-radius: 8px;
            border: none;
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            color: white;
            font-weight: 700;
            cursor: pointer;
        }

        .bid-btn:hover {
            transform: scale(1.05);
        }

        .bid-btn.pass {
            background: linear-gradient(135deg, #f44336, #c62828);
        }

        .trade-select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            margin-bottom: 12px;
        }

        .trade-select option {
            background: #1a1a2e;
        }

        .trade-props {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            max-height: 120px;
            overflow-y: auto;
            padding: 5px;
            margin-bottom: 8px;
        }

        .trade-prop {
            padding: 6px 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            font-size: 0.8rem;
        }

        .trade-prop.selected {
            border-color: var(--gold);
            background: rgba(255, 215, 0, 0.15);
        }

        .trade-input {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            margin-top: 6px;
        }

        .money-float {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
            font-size: 1.3rem;
            font-weight: 800;
            animation: floatUp 0.8s ease-out forwards;
        }

        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0);
            }

            100% {
                opacity: 0;
                transform: translateY(-40px);
            }
        }

        .money-float.pos {
            color: #4caf50;
        }

        .money-float.neg {
            color: #f44336;
        }

        /* MOBILE RESPONSIVE - MASTER DESIGN (Optimized) */
        @media (max-width: 900px) {
            .game-wrapper {
                flex-direction: column;
                height: 100vh;
                height: -webkit-fill-available;
                padding: 0;
                gap: 0;
                background: var(--bg-dark);
                overflow: hidden;
            }

            /* Hide Desktop Side Panels */
            .side-panel {
                display: none !important;
            }

            /* Show Mobile Specific Header */
            .mobile-header {
                display: flex !important;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: 60px;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(10px);
                z-index: 1000;
                padding: 0 15px;
                align-items: center;
                justify-content: space-between;
                border-bottom: 1px solid rgba(255, 215, 0, 0.2);
            }

            .mobile-player-info {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .mobile-money {
                color: var(--gold);
                font-weight: 800;
                font-size: 0.95rem;
            }

            /* Center Panel Layout */
            .center-panel {
                padding-top: 50px !important;
                padding-bottom: 75px !important;
                height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .board-container {
                width: 90vmin !important;
                height: 90vmin !important;
                margin: auto;
            }

            /* Board Refinements */
            .square-name {
                font-size: 0.38rem !important;
                line-height: 1.1;
                font-weight: 700 !important;
            }

            .square-price {
                font-size: 0.35rem !important;
                font-weight: 700 !important;
            }

            .token {
                width: 14px !important;
                height: 14px !important;
                font-size: 0.55rem !important;
            }

            /* Setup Responsive - Compact */
            .setup-screen {
                padding: 15px;
                justify-content: safe flex-start;
                align-items: center;
            }

            .setup-container {
                grid-template-columns: 1fr;
                padding: 20px;
                gap: 15px;
                width: 100%;
                border-radius: 16px;
                margin: 10px 0;
            }

            .setup-right {
                border-left: none !important;
                padding-left: 0 !important;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
                padding-top: 15px;
            }

            h1 {
                font-size: 2.2rem !important;
                letter-spacing: 12px !important;
            }

            .player-config-slot {
                padding: 10px !important;
                gap: 15px !important;
            }

            .token-preview {
                width: 50px !important;
                height: 50px !important;
                font-size: 1.5rem !important;
            }

            .btn-roll {
                height: 55px !important;
                font-size: 0.9rem !important;
            }

            .board-center {
                padding: 2px !important;
            }

            .center-logo {
                font-size: 0.9rem !important;
                margin-bottom: 0 !important;
            }

            .dice-container {
                transform: scale(0.65);
                margin: 0 !important;
            }

            /* Mobile Bottom Bar */
            .mobile-bottom-bar {
                display: flex !important;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: rgba(18, 20, 29, 0.95);
                backdrop-filter: blur(15px);
                padding: 10px 15px env(safe-area-inset-bottom);
                z-index: 1000;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
                justify-content: space-around;
                align-items: center;
                gap: 8px;
            }

            .mobile-bottom-bar .btn {
                padding: 8px 12px !important;
                font-size: 0.65rem !important;
                height: 48px;
                flex: 1;
            }

            .btn-roll-mob {
                flex: 1.5 !important;
                background: linear-gradient(135deg, var(--gold), #aa8a2e) !important;
                color: #000 !important;
            }

            .modal h2 {
                font-size: 1.4rem !important;
            }

            .modal p {
                font-size: 0.8rem !important;
            }
        }

        /* PREMIUM LANDSCAPE EXPERIENCE - WORLD CLASS UX (Root Level) */
        @media (max-height: 500px) and (orientation: landscape) {
            .game-wrapper {
                flex-direction: row !important;
                height: 100vh !important;
                overflow: hidden !important;
                display: flex !important;
                background: #020205 !important;
            }

            .mobile-header,
            .mobile-bottom-bar {
                display: none !important;
            }

            .side-panel {
                display: flex !important;
                width: 105px !important;
                min-width: 105px !important;
                padding: 3px !important;
                background: rgba(10, 10, 15, 0.95) !important;
                backdrop-filter: blur(25px);
                border: none !important;
                border-right: 1px solid rgba(212, 175, 55, 0.1) !important;
                z-index: 20;
            }

            /* Remove all bulky waste */
            .side-panel>div:first-child,
            .side-panel h1,
            .side-panel h2 {
                display: none !important;
            }

            .player-card {
                padding: 2px !important;
                margin-bottom: 2px !important;
                border-radius: 4px !important;
            }

            .player-header {
                gap: 3px !important;
            }

            .player-token-icon {
                width: 12px !important;
                height: 12px !important;
                border-width: 1px !important;
            }

            .player-name {
                font-size: 0.38rem !important;
                font-weight: 800 !important;
            }

            .player-money {
                font-size: 0.48rem !important;
                color: var(--gold) !important;
            }

            .player-props {
                gap: 1px !important;
                margin-top: 1px !important;
            }

            .prop-dot {
                width: 3px !important;
                height: 3px !important;
                border-radius: 1px !important;
            }

            .center-panel {
                flex: 1 !important;
                padding: 0 !important;
                height: 100vh !important;
                display: flex !important;
                align-items: center;
                justify-content: center;
                background: #000 !important;
            }

            .board-container {
                width: min(98vh, calc(100vw - 230px)) !important;
                height: min(98vh, calc(100vw - 230px)) !important;
                margin: auto !important;
                box-shadow: 0 0 100px rgba(0, 0, 0, 1);
            }

            /* Board Text Scale */
            .square-name {
                font-size: 0.23rem !important;
                line-height: 1 !important;
            }

            .square-price {
                font-size: 0.23rem !important;
            }

            .token {
                width: 8px !important;
                height: 8px !important;
                font-size: 0.28rem !important;
            }

            .dice-container {
                transform: scale(0.42) !important;
            }

            .center-logo {
                font-size: 0.9rem !important;
                letter-spacing: 5px !important;
            }

            .side-panel:last-child {
                width: 115px !important;
                min-width: 115px !important;
                border-left: 1px solid rgba(212, 175, 55, 0.1) !important;
                border-right: none !important;
            }

            .controls-vertical {
                gap: 1px !important;
                padding: 0 !important;
            }

            .controls-vertical .btn {
                height: 18px !important;
                font-size: 0.35rem !important;
                padding: 0 4px !important;
                border-radius: 3px !important;
                min-width: 0 !important;
            }

            #turnIndicator {
                padding: 2px !important;
                margin-bottom: 2px !important;
            }

            #currentPlayerName {
                font-size: 0.48rem !important;
            }

            .ui-settings {
                display: none !important;
            }

            .game-log {
                font-size: 0.32rem !important;
                flex: 1;
                margin-top: 2px !important;
                padding: 2px !important;
                background: rgba(0, 0, 0, 0.6) !important;
                line-height: 1.1 !important;
            }
        }

        .player-type-select {
            padding: 8px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-family: 'Montserrat', sans-serif;
            cursor: pointer;
            outline: none;
        }

        .player-type-select option {
            background: #1a1a2e;
            color: white;
        }

        .ai-badge {
            font-size: 0.7em;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--gold);
            color: #000;
            font-weight: bold;
            margin-left: 5px;
            vertical-align: middle;
        }
    </style>
</head>

<body>
    <div class="setup-screen" id="setupScreen">
        <div class="setup-container">
            <div style="grid-column: 1 / -1; text-align: center; margin-bottom: 15px;">
                <h1
                    style="font-family: 'Bebas Neue'; font-size: 4rem; letter-spacing: 12px; color: var(--gold); margin: 0; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.8));">
                    MONOPOLX</h1>
                <p
                    style="opacity: 0.4; font-size: 0.75rem; letter-spacing: 3px; font-weight: 800; color: white; margin-top: 5px;">
                    PREMIUM EDITION</p>
                <div style="width: 40px; height: 2px; background: var(--gold); margin: 12px auto; border-radius: 2px;">
                </div>
            </div>
            <div class="setup-left">
                <h3
                    style="margin-bottom:12px; color:var(--gold); display:flex; align-items:center; gap:8px; font-size:1rem;">
                    🌟 OYUNCULAR</h3>
                <div id="playerConfigs">
                    <!-- Player Slots -->
                    <div class="player-config-slot" data-p="1"
                        style="display:flex; align-items:center; gap:25px; background:rgba(255,255,255,0.02); padding:15px; border-radius:15px; border:1px solid rgba(255,255,255,0.05);">
                        <div class="token-preview token-red" id="preview-p1" onclick="openIconPicker(1)">🚗</div>
                        <div style="flex:1">
                            <input type="text" id="p1" value="Mustafa" maxlength="10"
                                style="width:100%; margin-bottom:10px; background:transparent; border:none; border-bottom:1.5px solid rgba(255,255,255,0.1); color:white; font-size:1.1rem; padding:5px 0;">
                            <div style="display:flex; gap:5px;">
                                <select id="t1" class="player-type-select" style="flex:1"
                                    onchange="autoName(1);togglePers(1)">
                                    <option value="human" selected>👤 İnsan</option>
                                    <option value="ai-easy">🤖 Kolay AI</option>
                                    <option value="ai-medium">🤖 Orta AI</option>
                                    <option value="ai-hard">🤖 Zor AI</option>
                                </select>
                                <select id="pers1" class="player-type-select" style="flex:1; display:none;">
                                    <option value="Random">🎲 Rastgele</option>
                                    <option value="Tycoon">💼 Kodaman</option>
                                    <option value="Banker">🏦 Bankacı</option>
                                    <option value="Opportunist">🦊 Fırsatçı</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="player-config-slot" data-p="2"
                        style="display:flex; align-items:center; gap:25px; background:rgba(255,255,255,0.02); padding:15px; border-radius:15px; border:1px solid rgba(255,255,255,0.05); margin-top:15px;">
                        <div class="token-preview token-blue" id="preview-p2" onclick="openIconPicker(2)">🎩</div>
                        <div style="flex:1">
                            <input type="text" id="p2" value="Robot-1" maxlength="10"
                                style="width:100%; margin-bottom:10px; background:transparent; border:none; border-bottom:1.5px solid rgba(255,255,255,0.1); color:white; font-size:1.1rem; padding:5px 0;">
                            <div style="display:flex; gap:5px;">
                                <select id="t2" class="player-type-select" style="flex:1"
                                    onchange="autoName(2);togglePers(2)">
                                    <option value="human">👤 İnsan</option>
                                    <option value="ai-easy">🤖 Kolay AI</option>
                                    <option value="ai-medium">🤖 Orta AI</option>
                                    <option value="ai-hard" selected>🤖 Zor AI</option>
                                </select>
                                <select id="pers2" class="player-type-select" style="flex:1;">
                                    <option value="Random">🎲 Rastgele</option>
                                    <option value="Tycoon">💼 Kodaman</option>
                                    <option value="Banker">🏦 Bankacı</option>
                                    <option value="Opportunist">🦊 Fırsatçı</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="player-config-slot" data-p="3"
                        style="display:flex; align-items:center; gap:25px; background:rgba(255,255,255,0.02); padding:15px; border-radius:15px; border:1px solid rgba(255,255,255,0.05); margin-top:15px;">
                        <div class="token-preview token-green" id="preview-p3" onclick="openIconPicker(3)">🐕</div>
                        <div style="flex:1">
                            <input type="text" id="p3" value="Robot-2" maxlength="10"
                                style="width:100%; margin-bottom:10px; background:transparent; border:none; border-bottom:1.5px solid rgba(255,255,255,0.1); color:white; font-size:1.1rem; padding:5px 0;">
                            <div style="display:flex; gap:5px;">
                                <select id="t3" class="player-type-select" style="flex:1"
                                    onchange="autoName(3);togglePers(3)">
                                    <option value="none">--- (Kapalı)</option>
                                    <option value="human">👤 İnsan</option>
                                    <option value="ai-easy">🤖 Kolay AI</option>
                                    <option value="ai-medium">🤖 Orta AI</option>
                                    <option value="ai-hard" selected>🤖 Zor AI</option>
                                </select>
                                <select id="pers3" class="player-type-select" style="flex:1;">
                                    <option value="Random">🎲 Rastgele</option>
                                    <option value="Tycoon">💼 Kodaman</option>
                                    <option value="Banker">🏦 Bankacı</option>
                                    <option value="Opportunist">🦊 Fırsatçı</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="player-config-slot" data-p="4"
                        style="display:flex; align-items:center; gap:25px; background:rgba(255,255,255,0.02); padding:15px; border-radius:15px; border:1px solid rgba(255,255,255,0.05); margin-top:15px;">
                        <div class="token-preview token-yellow" id="preview-p4" onclick="openIconPicker(4)">🦖</div>
                        <div style="flex:1">
                            <input type="text" id="p4" value="Robot-3" maxlength="10"
                                style="width:100%; margin-bottom:10px; background:transparent; border:none; border-bottom:1.5px solid rgba(255,255,255,0.1); color:white; font-size:1.1rem; padding:5px 0;">
                            <div style="display:flex; gap:5px;">
                                <select id="t4" class="player-type-select" style="flex:1"
                                    onchange="autoName(4);togglePers(4)">
                                    <option value="none">--- (Kapalı)</option>
                                    <option value="human">👤 İnsan</option>
                                    <option value="ai-easy" selected>🤖 Kolay AI</option>
                                    <option value="ai-medium">🤖 Orta AI</option>
                                    <option value="ai-hard">🤖 Zor AI</option>
                                </select>
                                <select id="pers4" class="player-type-select" style="flex:1;">
                                    <option value="Random">🎲 Rastgele</option>
                                    <option value="Tycoon">💼 Kodaman</option>
                                    <option value="Banker">🏦 Bankacı</option>
                                    <option value="Opportunist">🦊 Fırsatçı</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <h3
                    style="margin:30px 0 10px; color:rgba(255,255,255,0.5); font-size:0.8rem; letter-spacing:2px; text-transform:uppercase;">
                    🗺️ Harita Seçimi</h3>
                <div style="display:flex; gap:10px; align-items:center;">
                    <select id="mapSelect" class="player-type-select"
                        style="flex:1; height:50px; border-color:rgba(255,255,255,0.1); background:rgba(255,255,255,0.05);">
                        <option value="turkiye" selected>🇹🇷 Türkiye Turu</option>
                        <option value="istanbul">🏙️ İstanbul Boğazı</option>
                        <option value="world">🗺️ Global Cities</option>
                    </select>
                    <div
                        style="background:rgba(255, 61, 0, 0.1); padding:10px; border-radius:12px; border:1px solid rgba(255, 61, 0, 0.2); display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" id="challengeMode" style="width:18px; height:18px; cursor:pointer;"
                            checked>
                        <label for="challengeMode"
                            style="font-size:0.7rem; font-weight:800; color:#ff3d00; cursor:pointer;">🔥 CHALLENGE
                            MODE</label>
                    </div>
                </div>
            </div>

            <div class="setup-right" style="border-left: 1px solid rgba(255,255,255,0.05); padding-left:40px;">
                <h3
                    style="margin-bottom:20px; color:rgba(255,255,255,0.5); font-size:0.8rem; letter-spacing:2px; text-transform:uppercase;">
                    🏛️ Görünüm Teması</h3>
                <div class="theme-preview">
                    <div class="theme-card" id="theme-premium" onclick="setTheme('premium')">
                        <div style="background:var(--bg-dark); border:1px solid var(--gold)"></div>
                        <span>Premium Dark</span>
                    </div>
                    <div class="theme-card" id="theme-marble" onclick="setTheme('marble')">
                        <div style="background:var(--marble-bg); border:1px solid #ccc"></div>
                        <span>Luxury Marble</span>
                    </div>
                    <div class="theme-card selected" id="theme-parchment" onclick="setTheme('parchment')">
                        <div style="background:var(--paper-bg); border:1px solid #8d6e63"></div>
                        <span>Classic Paper</span>
                    </div>
                </div>

                <h3
                    style="margin-bottom:20px; color:rgba(255,255,255,0.5); font-size:0.8rem; letter-spacing:2px; text-transform:uppercase;">
                    ⚖️ Oyun Kuralları</h3>
                <div class="rules-box"
                    style="background: rgba(255,255,255,0.02); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
                    <div class="rule-item">
                        <label style="font-size: 0.7rem; opacity: 0.6;">BAŞLANGIÇ PARASI (₺)</label>
                        <input type="number" id="ruleStartMoney" class="rule-input" value="1500" step="100"
                            style="background:transparent; border:none; border-bottom:1px solid rgba(255,255,255,0.1); color:var(--gold); font-weight:700;">
                    </div>
                    <div class="rule-item" style="margin-top:10px;">
                        <label style="font-size: 0.7rem; opacity: 0.6;">MAAŞ (₺)</label>
                        <input type="number" id="ruleSalary" class="rule-input" value="200" step="50"
                            style="background:transparent; border:none; border-bottom:1px solid rgba(255,255,255,0.1); color:var(--gold); font-weight:700;">
                    </div>
                    <div class="rule-item"
                        style="margin-top:15px; display:flex; justify-content:space-between; align-items:center;">
                        <label style="font-size: 0.7rem; opacity: 0.6;">PARK HAVUZU</label>
                        <div class="rule-toggle on" id="toggleParkPool" onclick="this.classList.toggle('on')"></div>
                    </div>
                    <div class="rule-item"
                        style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
                        <label style="font-size: 0.7rem; opacity: 0.6;">RASTGELE BAŞLANGIÇ</label>
                        <div class="rule-toggle on" id="toggleRandomStart" onclick="this.classList.toggle('on')"></div>
                    </div>
                </div>
                <button class="btn btn-roll"
                    style="width:100%; margin-top:30px; height:65px; font-size:1.2rem; letter-spacing:4px; border-radius:12px; background: linear-gradient(to right, #d4af37, #f9e29d); color:#000; font-weight:800; border:none; cursor:pointer; transition:all 0.4s;"
                    onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 0 30px rgba(212,175,55,0.4)'"
                    onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'"
                    onclick="startGame()">OYUNA BAŞLA</button>
                <button id="resumeBtn" class="btn btn-secondary"
                    style="width:100%; margin-top:10px; height:50px; font-size:1rem; letter-spacing:2px; border-radius:12px; display:none;"
                    onclick="loadGame()">ÖNCEKİ OYUNA DEVAM ET</button>

            </div>
        </div>
        <div class="credit-badge">MADE BY <span>MUSTAFA EVLEKSİZ</span> <small id="ver1"
                style="opacity: 0.5; font-size: 0.6rem; margin-left: 5px;">v3.3.1</small> ✨</div>

    </div>
    <div class="game-wrapper" id="gameContainer" style="display:none">
        <!-- Mobile Header (Hidden on Desktop) -->
        <div class="mobile-header" style="display:none">
            <div class="mobile-player-info">
                <div id="mobCurrentIcon" style="font-size:1.5rem">🚗</div>
                <div>
                    <div id="mobCurrentName" style="font-weight:800; font-size:0.9rem;">Mustafa</div>
                    <div id="mobCurrentMoney" class="mobile-money">1500₺</div>
                </div>
            </div>
            <div onclick="location.reload()"
                style="font-family:'Bebas Neue'; color:var(--gold); font-size:1.4rem; letter-spacing:2px; cursor:pointer;">
                MONOPOLX</div>
            <div style="display:flex; gap:5px;">
                <button class="btn btn-secondary"
                    style="padding:0; min-width:38px; height:38px; border-radius:10px; font-size:1.1rem; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.05);"
                    onclick="openStats()" title="İstatistikler">📊</button>
                <button class="btn btn-secondary"
                    style="padding:0; min-width:38px; height:38px; border-radius:10px; font-size:1.1rem; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.05);"
                    onclick="document.getElementById('quickSettingsModal').classList.add('active')"
                    title="Ayarlar">⚙️</button>
            </div>
        </div>

        <!-- Sol Panel: Oyuncu Listesi -->
        <div class="side-panel players-side">
            <div
                style="text-align: center; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px;">
                <h1 style="font-family: 'Bebas Neue'; font-size: 2.2rem; letter-spacing: 4px; color: var(--gold); margin: 0; cursor:pointer;"
                    onclick="location.reload()">
                    MONOPOLX</h1>
                <div style="font-size: 0.6rem; opacity: 0.4; letter-spacing: 1px;">BY MUSTAFA EVLEKSİZ <span id="ver2"
                        style="font-size: 0.5rem; opacity: 0.5; margin-left: 3px;">v3.3.1</span></div>
            </div>
            <h2 style="font-family: 'Bebas Neue'; color: var(--gold); font-size: 1.3rem; letter-spacing: 2px;">👥
                OYUNCULAR</h2>
            <div id="playersPanel" style="display: flex; flex-direction: column; gap: 8px; margin-top:10px;"></div>
            <div id="parkDisp"
                style="margin-top: auto; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 10px; text-align: center; border: 1px dashed var(--gold);">
            </div>
        </div>

        <!-- Orta Panel: Board -->
        <div class="center-panel">
            <div class="board-container">
                <div class="board" id="board"></div>
            </div>
        </div>

        <!-- Mobile Bottom Bar (Hidden on Desktop) -->
        <div class="mobile-bottom-bar" style="display:none">
            <button class="btn btn-secondary" onclick="openTrade()" title="Takas">🔄</button>
            <button class="btn btn-secondary" onclick="openBuild()" title="Ev/Otel">🏗️</button>
            <button class="btn btn-roll btn-roll-mob" id="mobRollBtn" onclick="rollDice()">🎲 ZAR AT</button>
            <button class="btn btn-action" id="mobBuyBtn" onclick="buyProp()" disabled>🏠 AL</button>
            <button class="btn btn-end" id="mobEndBtn" onclick="endTurn()" disabled>⏭️</button>
        </div>

        <!-- Sağ Panel: Kontroller ve Log -->
        <div class="side-panel">
            <h2 style="font-family: 'Bebas Neue'; color: var(--gold); font-size: 1.8rem; letter-spacing: 2px;">🎮
                KONTROLLER</h2>
            <div class="controls-vertical">
                <div class="ai-waiting-overlay" id="aiOverlay">
                    <div style="font-size: 2rem; margin-bottom: 5px;">🤖</div>
                    <div style="font-weight: 700; color: var(--gold); font-size: 0.9rem;">
                        <span id="aiWaitingPlayerName">Yapay Zeka</span> Bekleniyor<span class="loading-dots"></span>
                    </div>
                </div>
                <div id="turnIndicator"
                    style="text-align:center; padding:10px; background:rgba(255,255,255,0.05); border-radius:8px; margin-bottom:10px; border:1px solid rgba(255,255,255,0.1);">
                    <div style="font-size:0.7rem; opacity:0.7; text-transform:uppercase; letter-spacing:1px;">OYUN
                        SIRASI</div>
                    <div id="currentPlayerName" style="font-weight:700; color:var(--gold); font-size:1.1rem;">-</div>
                </div>
                <button class="btn btn-roll" id="rollBtn" onclick="rollDice()">🎲 ZAR AT</button>
                <div id="jailControls" style="display:none; flex-direction: column; gap: 8px; margin-bottom: 8px;">
                    <button class="btn btn-action" onclick="payJail()">💸 CEZA ÖDE (50₺)</button>
                    <button class="btn btn-secondary" id="useJailCardBtn" onclick="useJailCard()" disabled>🎫 KART
                        KULLAN</button>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <button class="btn btn-action" id="buyBtn" onclick="buyProp()" disabled>🏠 AL</button>
                    <button class="btn btn-action" id="auctionBtn" onclick="startAuction()" disabled
                        style="display:none">🔨 İhale</button>
                    <button class="btn btn-action" id="buildBtn" onclick="openBuild()" disabled>🏗️ EV</button>
                    <button class="btn btn-secondary" onclick="openMortgage()">💰 İPOTEK</button>
                </div>
                <button class="btn btn-secondary" style="width:100%" onclick="openTrade()">🔄 TAKAS YAP</button>
                <div class="ui-settings"
                    style="margin-bottom:15px; background:rgba(255,255,255,0.04); padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <span style="font-size:0.7rem; opacity:0.6; font-weight:700; letter-spacing:1px;">GÖRÜNÜM
                            TEMASI</span>
                        <div style="display:flex; gap:8px;">
                            <div onclick="setTheme('premium')"
                                style="width:18px; height:18px; border-radius:50%; background:#12141d; border:1.5px solid #d4af37; cursor:pointer; box-shadow:0 0 5px rgba(0,0,0,0.5);"
                                title="Premium"></div>
                            <div onclick="setTheme('marble')"
                                style="width:18px; height:18px; border-radius:50%; background:#fff; border:1.5px solid #aaa; cursor:pointer; box-shadow:0 0 5px rgba(0,0,0,0.2);"
                                title="Marble"></div>
                            <div onclick="setTheme('parchment')"
                                style="width:18px; height:18px; border-radius:50%; background:#f4e4bc; border:1.5px solid #8d6e63; cursor:pointer; box-shadow:0 0 5px rgba(0,0,0,0.2);"
                                title="Paper"></div>
                        </div>
                    </div>
                    <label
                        style="font-size:0.7rem; opacity:0.6; font-weight:700; letter-spacing:1px; display:block; margin-bottom:5px;">HIZ:
                        <span id="speedVal" style="color:var(--gold)">ŞİMŞEK</span></label>
                    <input type="range" id="speedRange" min="50" max="350" value="350" step="10"
                        style="width: 100%; cursor: pointer; accent-color: var(--gold);" oninput="updateSpeedDisp()">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:12px;">
                        <span style="font-size:0.7rem; opacity:0.6; font-weight:700; letter-spacing:1px;">SES
                            EFEKTLERİ</span>
                        <div class="rule-toggle on" id="toggleSound" onclick="toggleSoundEffect()"
                            style="transform:scale(0.8)"></div>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:12px;">
                        <span style="font-size:0.7rem; opacity:0.6; font-weight:700; letter-spacing:1px;">DİL /
                            LANG</span>
                        <div onclick="toggleLang()"
                            style="cursor:pointer; font-size:0.7rem; font-weight:700; color:var(--gold); border:1px solid var(--gold); padding:2px 8px; border-radius:4px;"
                            id="langLabel">TR</div>
                    </div>
                </div>

                <button class="btn btn-end" id="endBtn" onclick="endTurn()" disabled>⏭️ TURU BİTİR</button>
            </div>
            <h2
                style="font-family: 'Bebas Neue'; color: var(--gold); font-size: 1.8rem; letter-spacing: 2px; margin-top:10px;">
                📝 KAYITLAR</h2>
            <div class="game-log" id="gameLog" style="flex:1; max-height:none;"></div>
        </div>
    </div>
    <div class="modal-overlay" id="iconModal">
        <div class="modal" style="max-width: 650px; width: 95%;">
            <div
                style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:15px; margin-bottom:20px;">
                <h2 style="color:var(--gold); margin:0;">🎭 Piyonunu Seç</h2>
                <div style="font-size:0.7rem; opacity:0.5; font-weight:800; letter-spacing:1px;">MONOPOLX PREMIUM</div>
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:20px;" id="iconCategories">
                <button class="icon-category-btn active" onclick="filterIcons('all', this)">Tümü</button>
                <button class="icon-category-btn" onclick="filterIcons('classic', this)">Klasik</button>
                <button class="icon-category-btn" onclick="filterIcons('animals', this)">Hayvanlar</button>
                <button class="icon-category-btn" onclick="filterIcons('travel', this)">Gezi</button>
                <button class="icon-category-btn" onclick="filterIcons('objects', this)">Objeler</button>
            </div>
            <div class="icon-modal-grid" id="iconGrid"></div>
            <div class="modal-buttons"
                style="margin-top:25px; border-top:1px solid rgba(255,255,255,0.05); padding-top:20px;">
                <button class="btn btn-secondary" style="width:100%" onclick="closeModal('iconModal')">İptal</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="propModal">
        <div class="modal">
            <h2>📋 Mülk</h2>
            <div id="propInfo"></div>
            <div class="modal-details" id="propDetails"></div>
            <div class="modal-buttons"><button class="btn btn-secondary"
                    onclick="closeModal('propModal')">Kapat</button></div>
        </div>
    </div>
    <div class="modal-overlay" id="cardModal">
        <div class="modal">
            <h2 id="cardTitle">Kart</h2>
            <div class="card-display">
                <div class="card-inner">
                    <div class="card-icon" id="cardIcon">🎴</div>
                    <p class="card-text" id="cardText"></p>
                </div>
            </div>
            <div class="modal-buttons"><button class="btn btn-roll" onclick="closeModal('cardModal')">Tamam</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="buildModal">
        <div class="modal">
            <h2>🏗️ İnşaat</h2>
            <div id="buildList"></div>
            <div class="modal-buttons"><button class="btn btn-secondary"
                    onclick="closeModal('buildModal')">Kapat</button></div>
        </div>
    </div>
    <div class="modal-overlay" id="tradeOfferModal">
        <div class="modal" style="max-width: 500px; border: 2px solid var(--gold);">
            <div style="text-align:center; margin-bottom:20px;">
                <h2 style="color:var(--gold); margin:0;">🤝 TAKAS TEKLİFİ</h2>
                <p id="tradeOfferText" style="opacity:0.8; margin-top:10px; font-weight:600;"></p>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:20px;">
                <div
                    style="background:rgba(255,255,255,0.03); padding:15px; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                    <div style="font-size:0.7rem; opacity:0.5; margin-bottom:8px; text-transform:uppercase;">VERECEĞİ
                    </div>
                    <div id="tradeOfferGiver" style="font-size:0.9rem;"></div>
                </div>
                <div
                    style="background:rgba(255,255,255,0.03); padding:15px; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                    <div style="font-size:0.7rem; opacity:0.5; margin-bottom:8px; text-transform:uppercase;">İSTEDİĞİ
                    </div>
                    <div id="tradeOfferTaker" style="font-size:0.9rem;"></div>
                </div>
            </div>
            <div class="modal-buttons" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn btn-action" id="acceptTradeBtn">✅ KABUL ET</button>
                <button class="btn btn-end" id="rejectTradeBtn">❌ REDDET</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="mortgageModal">
        <div class="modal">
            <h2>💰 İpotek</h2>
            <div id="mortgageList"></div>
            <div class="modal-buttons"><button class="btn btn-secondary"
                    onclick="closeModal('mortgageModal')">Kapat</button></div>
        </div>
    </div>
    <div class="modal-overlay" id="tradeModal">
        <div class="modal">
            <h2>🔄 Değiş Tokuş</h2><select id="tradePlayer" class="trade-select" onchange="updateTrade()"></select>
            <div style="margin-bottom:12px">
                <div style="color:#4caf50;font-weight:600;margin-bottom:6px">📤 Vereceğin:</div>
                <div class="trade-props" id="myProps"></div><input type="number" class="trade-input" id="myMoney"
                    placeholder="Para (₺)" min="0">
            </div>
            <div style="margin-bottom:12px">
                <div style="color:#f44336;font-weight:600;margin-bottom:6px">📥 Alacağın:</div>
                <div class="trade-props" id="theirProps"></div><input type="number" class="trade-input" id="theirMoney"
                    placeholder="Para (₺)" min="0">
            </div>
            <div class="modal-buttons"><button class="btn btn-action" onclick="doTrade()">✅ Teklif Et</button><button
                    class="btn btn-secondary" onclick="closeModal('tradeModal')">İptal</button></div>
        </div>
    </div>
    <div class="modal-overlay" id="quickSettingsModal">
        <div class="modal" style="max-width: 320px;">
            <div style="text-align:center; margin-bottom:20px;">
                <h2 style="color:var(--gold); margin:0; font-size:1.4rem;">⚙️ HIZLI AYARLAR</h2>
            </div>
            <div class="ui-settings"
                style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; border:1px solid rgba(255,255,255,0.05);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <span style="font-size:0.75rem; font-weight:700; opacity:0.6;">TEMA DEĞİŞTİR</span>
                    <div style="display:flex; gap:10px;">
                        <div onclick="setTheme('premium')"
                            style="width:22px; height:22px; border-radius:50%; background:#12141d; border:2px solid #d4af37; cursor:pointer;">
                        </div>
                        <div onclick="setTheme('marble')"
                            style="width:22px; height:22px; border-radius:50%; background:#fff; border:2px solid #aaa; cursor:pointer;">
                        </div>
                        <div onclick="setTheme('parchment')"
                            style="width:22px; height:22px; border-radius:50%; background:#f4e4bc; border:2px solid #8d6e63; cursor:pointer;">
                        </div>
                    </div>
                </div>
                <label style="font-size:0.75rem; font-weight:700; opacity:0.6; display:block; margin-bottom:8px;">OYUN
                    HIZI</label>
                <input type="range" id="speedRangeMob" min="50" max="350" value="350" step="10"
                    style="width: 100%; cursor: pointer; accent-color: var(--gold);"
                    oninput="document.getElementById('speedRange').value = this.value; updateSpeedDisp()">
            </div>
            <div class="modal-buttons" style="margin-top:20px;">
                <button class="btn btn-secondary" style="width:100%"
                    onclick="closeModal('quickSettingsModal')">KAPAT</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="statsModal">
        <div class="modal" style="max-width: 450px;">
            <div style="text-align:center; margin-bottom:20px;">
                <h2 style="color:var(--gold); margin:0;">📊 OYUN İSTATİSTİKLERİ</h2>
            </div>
            <div id="statsContent"
                style="display:flex; flex-direction:column; gap:15px; max-height:60vh; overflow-y:auto; padding-right:5px;">
                <!-- Player Stat Cards -->
            </div>
            <div class="modal-buttons" style="margin-top:20px;">
                <button class="btn btn-secondary" style="width:100%" onclick="closeModal('statsModal')">KAPAT</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="auctionModal">
        <div class="modal">
            <h2>🔨 Açık Artırma</h2>
            <div id="auctionProp"></div>
            <div class="auction-bid" id="auctionBid">0₺</div>
            <div class="auction-info" id="auctionInfo"></div>
            <div class="auction-players" id="auctionPlayers"></div>
            <div class="bid-btns" id="bidBtns"></div>
        </div>
    </div>
    <div class="modal-overlay" id="winModal">
        <div class="modal">
            <h2>🏆 KAZANAN!</h2>
            <div class="card-display">
                <div class="card-inner">
                    <div class="card-icon">🎉</div>
                    <p class="card-text" id="winText"></p>
                </div>
            </div>
            <div class="modal-buttons"><button class="btn btn-roll" onclick="location.reload()">🔄 Yeni Oyun</button>
            </div>
        </div>
    </div>
    <script>
        // GLOBAL FUNCTIONS - ATTACH TO WINDOW FOR RELIABILITY
        window.openStats = function () {
            const stats = document.getElementById('statsContent');
            if (!stats) return;
            stats.innerHTML = '';
            G.players.forEach(p => {
                if (p.out) return;
                const card = document.createElement('div');
                card.style.cssText = 'background:rgba(20,20,30,0.98); padding:10px; border-radius:10px; border:1px solid ' + COLORS[p.color] + '44; margin-bottom:8px; box-shadow:0 4px 15px rgba(0,0,0,0.4);';

                const propGroups = {};
                p.props.forEach(id => {
                    const s = window.activeSQ[id];
                    const color = s.color || (s.type === 'railroad' ? '#333' : '#9c27b0');
                    if (!propGroups[color]) propGroups[color] = [];
                    propGroups[color].push(s.name);
                });

                let propHTML = '';
                Object.keys(propGroups).forEach(color => {
                    propHTML += '<div style="display:flex; flex-wrap:wrap; gap:4px; margin-top:8px;">';
                    propGroups[color].forEach(name => {
                        propHTML += '<span style="background:' + color + '; color:' + ((color === '#fff' || color === '#ffeb3b') ? '#000' : '#fff') + '; padding:2px 5px; border-radius:3px; font-size:0.5rem; font-weight:800; border:1px solid rgba(255,255,255,0.1);">' + name + '</span>';
                    });
                    propHTML += '</div>';
                });

                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:900; color:${COLORS[p.color]}; font-size:0.75rem;">${p.icon} ${p.name.toUpperCase()}</span>
                        <span style="font-weight:900; color:var(--gold); font-size:0.85rem;">${p.money.toLocaleString()}₺</span>
                    </div>
                    ${propHTML || '<div style="opacity:0.4; font-size:0.6rem; margin-top:5px;">Mülk yok</div>'}
                `;
                stats.appendChild(card);
            });
            document.getElementById('statsModal').classList.add('active');
        };

        let selectedIcons = { 1: '🚗', 2: '🎩', 3: '🐕', 4: '🦖' }; // Default icons
        const TOKEN_ICONS_ALL = ['🚗', '🎩', '🐕', '🚢', '🦖', '👞', '🧺', '🐈', '🚀', '🚁', '🚂', '🐎', '🦢', '🐢', '🐙', '👾', '🤖', '👻', '👽', '👑', '💎', '💰', '🔑', '🔔', '⚓', '⛵', '🌟', '⚡', '🔥', '💧', '🌿', '🌸', '🍄', '🌈', '☀️', '🌙', '⭐', '🌍', '💡', '⚙️', '⚖️', '🛠️', '🛡️', '⚔️', '🔮', '🪄', '🎲', '🧩', '🎯', '🎳', '🎤', '🎧', '🎸', '🎹', '🥁', '🎺', '🎻', '🎨', '🎭', '🎬', '📸', '🎥', '💻', '📱', '⌚', '💾', '🖨️', '🖱️', '⌨️', '📞', '📠', '📡', '🛰️', '💡', '🔌', '🔋', '🧲', '🧪', '🔬', '🔭', '🧬', '🦠', '💉', '💊', '🩹', '🩺', '🌡️', '🩸', '🩻', '🩼', '🩽', '🩾', '🩿', '🪀', '🪁', '🪂', '🪃', '🪄', '🪅', '🪆', '🪇', '🪈', '🪉', '🪊', '🪋', '🪌', '🪍', '🪎', '🪏', '🪐', '🪑', '🪒', '🪓', '🪔', '🪕', '🪖', '🪗', '🪘', '🪙', '🪚', '🪛', '🪜', '🪝', '🪞', '🪟', '🪠', '🪡', '🪢', '🧶', '🧵', '🪟', '🪠', '🪡', '🪢', '🧶', '🧵', '🪧', '🪨', '🪩', '🪪', '🪫', '🪬', '🪭', '🪮', '🪯', '🪰', '🪱', '🪲', '🪳', '🪴', '🪵', '🪶', '🪷', '🪸', '🪹', '🪺', '🪻', '🪼', '🪽', '🪾', '🪿', '🫀', '🫁', '🫂', '🫃', '🫄', '🫅', '🫆', '🫇', '🫈', '🫉', '🫊', '🫋', '🫌', '🫍', '🫎', '🫏', '🫐', '🫑', '🫒', '🫓', '🫔', '🫕', '🫖', '🫗', '🫘', '🫙', '🫚', '🫛', '🫜', '🫝', '🫞', '🫟', '🫠', '🫡', '🫢', '🫣', '🫤', '🫥', '🫠', '🫧', '🫨', '🫩', '🫪', '🫫', '🫬', '🫭', '🫮', '🫯', '🫰', '🫱', '🫲', '🫳', '🫴', '🫵', '🫶', '🫷', '🫸', '🫹', '🫺', '🫻', '🫼', '🫽', '🫾', '🫿', '🬀', '🬁', '🬂', '🬃', '🬄', '🬅', '🬆', '🬇', '🬈', '🬉', '🬊', '🬋', '🬌', '🬍', '🬎', '🬏', '🬐', '🬑', '🬒', '🬓', '🬔', '🬕', '🬖', '🬗', '🬘', '🬙', '🬚', '🬛', '🬜', '🬝', '🬞', '🬟', '🬠', '🬡', '🬢', '🬣', '🬤', '🬥', '🬦', '🬧', '🬨', '🬩', '🬪', '🬫', '🬬', '🬭', '🬮', '🬯', '🬰', '🬱', '🬲', '🬳', '🬴', '🬵', '🬶', '🬷', '🬸', '🬹', '🬺', '🬻', '🬼', '🬽', '🬾', '🬿', '🭀', '🭁', '🭂', '🭃', '🭄', '🭅', '🭆', '🭇', '🭈', '🭉', '🭊', '🭋', '🭌', '🭍', '🭎', '🭏', '🭐', '🭑', '🭒', '🭓', '🭔', '🭕', '🭖', '🭗', '🭘', '🭙', '🭚', '🭛', '🭜', '🭝', '🭞', '🭟', '🭠', '🭡', '🭢', '🭣', '🭤', '🭥', '🭦', '🭧', '🭨', '🭩', '🭪', '🭫', '🭬', '🭭', '🭮', '🭯', '🭰', '🭱', '🭲', '🭳', '🭴', '🭵', '🭶', '🭷', '🭸', '🭹', '🭺', '🭻', '🭼', '🭽', '🭾', '🭿', '🮀', '🮁', '🮂', '🮃', '🮄', '🮅', '🮆', '🮇', '🮈', '🮉', '🮊', '🮋', '🮌', '🮍', '🮎', '🮏', '🮐', '🮑', '🮒', '🮓', '🮔', '🮕', '🮖', '🮗', '🮘', '🮙', '🮚', '🮛', '🮜', '🮝', '🮞', '🮟', '🮠', '🮡', '🮢', '🮣', '🮤', '🮥', '🮦', '🮧', '🮨', '🮩', '🮪', '🮫', '🮬', '🮭', '🮮', '🮯', '🮰', '🮱', '🮲', '🮳', '🮴', '🮵', '🮶', '🮷', '🮸', '🮹', '🮺', '🮻', '🮼', '🮽', '🮾', '🮿', '🯀', '🯁', '🯂', '🯃', '🯄', '🯅', '🯆', '🯇', '🯈', '🯉', '🯊', '🯋', '🯌', '🯍', '🯎', '🯏', '🯐', '🯑', '🯒', '🯓', '🯔', '🯕', '🯖', '🯗', '🯘', '🯙', '🯚', '🯛', '🯜', '🯝', '🯞', '🯟', '🯠', '🯡', '🯢', '🯣', '🯤', '🯥', '🯦', '🯧', '🯨', '🯩', '🯪', '🯫', '🯬', '🯭', '🯮', '🯯', '🯰', '🯱', '🯲', '🯳', '🯴', '🯵', '🯶', '🯷', '🯸', '🯹', '🯺', '🯻', '🯼', '🯽', '🯾', '🯿'];

        function autoName(num) {
            const type = document.getElementById('t' + num).value;
            const input = document.getElementById('p' + num);
            const preview = document.getElementById('preview-p' + num);
            if (type === 'none') {
                input.value = '';
                if (preview) preview.style.opacity = '0.2';
                return;
            }
            if (preview) preview.style.opacity = '1';
            if (type === 'human') input.value = (num === 1 ? 'Mustafa' : 'Oyuncu ' + num);
            else input.value = 'Robot-' + (num - 1 || 'X');
        }

        const CATEGORIZED_ICONS = {
            classic: ['🚗', '🎩', '🐕', '🚢', '🦖', '👞', '🧺', '🐈', '🚀', '🚁', '🚂', '🐎'],
            animals: ['🦆', '🐢', '🦢', '🦅', '🦄', '🐝', '🦋', '🐙', '🦖', '🦜', '🦩', '🐘', '🦍', '🐳', '🦀', '🦁', '🦉', '🦙'],
            travel: ['🌍', '⛵', '🚁', '🛩️', '🏍️', '🚲', '🛴', '🗺️', '🗼', '🏔️', '🏖️', '🏰', '🏕️', '🎡', '🚜', '🛶', '⛺'],
            objects: ['💎', '👑', '💰', '🔑', '🔔', '⚓', '🎲', '🧩', '🎯', '🎤', '🎧', '🎸', '🎨', '🎭', '🎬', '📸', '💾', '💡', '🛡️', '⚙️']
        };

        let currentPickingPlayer = null;
        function togglePers(pIdx) {
            const t = document.getElementById('t' + pIdx).value;
            const pers = document.getElementById('pers' + pIdx);
            if (pers) pers.style.display = t.startsWith('ai') ? 'block' : 'none';
        }

        function initIconSelectors() {
            // No longer populates inline lists. Just initializes default previews.
            for (let i = 1; i <= 4; i++) {
                selectIcon(i, selectedIcons[i]);
            }
        }

        function openIconPicker(playerNum) {
            currentPickingPlayer = playerNum;
            filterIcons('all', document.querySelector('#iconCategories .active'));
            document.getElementById('iconModal').style.display = 'flex';
        }

        function filterIcons(cat, btn) {
            const grid = document.getElementById('iconGrid');
            grid.innerHTML = '';

            // UI Toggle
            document.querySelectorAll('.icon-category-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            let list = [];
            if (cat === 'all') {
                Object.values(CATEGORIZED_ICONS).forEach(l => list = list.concat(l));
            } else {
                list = CATEGORIZED_ICONS[cat];
            }

            // Remove duplicates
            list = [...new Set(list)];

            list.forEach(icon => {
                const opt = document.createElement('div');
                opt.className = 'icon-opt-big';
                opt.textContent = icon;
                if (Object.values(selectedIcons).includes(icon)) {
                    opt.style.opacity = '0.3';
                    opt.style.pointerEvents = 'none';
                }
                opt.onclick = () => {
                    selectIcon(currentPickingPlayer, icon);
                    closeModal('iconModal');
                };
                grid.appendChild(opt);
            });
        }

        function selectIcon(playerNum, icon) {
            selectedIcons[playerNum] = icon;
            const preview = document.getElementById(`preview-p${playerNum}`);
            if (preview) preview.textContent = icon;
        }
        function setTheme(themeName) {
            document.body.className = ''; // Clear existing themes
            document.body.classList.add(`theme-${themeName}`);

            document.querySelectorAll('.theme-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById(`theme-${themeName}`).classList.add('selected');
        }

        const SQ = [{ id: 0, name: "BAŞLA", type: "go" }, { id: 1, name: "Akdeniz Cd.", type: "property", color: "#8B4513", price: 60, rent: [2, 10, 30, 90, 160, 250], hc: 50, g: "brown" }, { id: 2, name: "Sandık", type: "chest" }, { id: 3, name: "Marmara Sk.", type: "property", color: "#8B4513", price: 60, rent: [4, 20, 60, 180, 320, 450], hc: 50, g: "brown" }, { id: 4, name: "Gelir Vergisi", type: "tax", amount: 200 }, { id: 5, name: "Haydarpaşa", type: "railroad", price: 200, rent: [25, 50, 100, 200] }, { id: 6, name: "Ege Blv.", type: "property", color: "#87CEEB", price: 100, rent: [6, 30, 90, 270, 400, 550], hc: 50, g: "lightblue" }, { id: 7, name: "Şans", type: "chance" }, { id: 8, name: "Karadeniz Cd.", type: "property", color: "#87CEEB", price: 100, rent: [6, 30, 90, 270, 400, 550], hc: 50, g: "lightblue" }, { id: 9, name: "Trakya Sk.", type: "property", color: "#87CEEB", price: 120, rent: [8, 40, 100, 300, 450, 600], hc: 50, g: "lightblue" }, { id: 10, name: "HAPİS", type: "jail" }, { id: 11, name: "Ankara Cd.", type: "property", color: "#FF69B4", price: 140, rent: [10, 50, 150, 450, 625, 750], hc: 100, g: "pink" }, { id: 12, name: "Elektrik Şti.", type: "utility", price: 150 }, { id: 13, name: "İzmir Sk.", type: "property", color: "#FF69B4", price: 140, rent: [10, 50, 150, 450, 625, 750], hc: 100, g: "pink" }, { id: 14, name: "Bursa Blv.", type: "property", color: "#FF69B4", price: 160, rent: [12, 60, 180, 500, 700, 900], hc: 100, g: "pink" }, { id: 15, name: "Sirkeci", type: "railroad", price: 200, rent: [25, 50, 100, 200] }, { id: 16, name: "Antalya Cd.", type: "property", color: "#FFA500", price: 180, rent: [14, 70, 200, 550, 750, 950], hc: 100, g: "orange" }, { id: 17, name: "Sandık", type: "chest" }, { id: 18, name: "Adana Sk.", type: "property", color: "#FFA500", price: 180, rent: [14, 70, 200, 550, 750, 950], hc: 100, g: "orange" }, { id: 19, name: "Konya Blv.", type: "property", color: "#FFA500", price: 200, rent: [16, 80, 220, 600, 800, 1000], hc: 100, g: "orange" }, { id: 20, name: "PARK", type: "parking" }, { id: 21, name: "Trabzon Cd.", type: "property", color: "#FF0000", price: 220, rent: [18, 90, 250, 700, 875, 1050], hc: 150, g: "red" }, { id: 22, name: "Şans", type: "chance" }, { id: 23, name: "Samsun Sk.", type: "property", color: "#FF0000", price: 220, rent: [18, 90, 250, 700, 875, 1050], hc: 150, g: "red" }, { id: 24, name: "Erzurum Blv.", type: "property", color: "#FF0000", price: 240, rent: [20, 100, 300, 750, 925, 1100], hc: 150, g: "red" }, { id: 25, name: "Ankara İst.", type: "railroad", price: 200, rent: [25, 50, 100, 200] }, { id: 26, name: "Eskişehir Cd.", type: "property", color: "#FFFF00", price: 260, rent: [22, 110, 330, 800, 975, 1150], hc: 150, g: "yellow" }, { id: 27, name: "Kayseri Sk.", type: "property", color: "#FFFF00", price: 260, rent: [22, 110, 330, 800, 975, 1150], hc: 150, g: "yellow" }, { id: 28, name: "Su Şti.", type: "utility", price: 150 }, { id: 29, name: "Gaziantep", type: "property", color: "#FFFF00", price: 280, rent: [24, 120, 360, 850, 1025, 1200], hc: 150, g: "yellow" }, { id: 30, name: "HAPİSE GİT", type: "gotojail" }, { id: 31, name: "Bodrum Cd.", type: "property", color: "#228B22", price: 300, rent: [26, 130, 390, 900, 1100, 1275], hc: 200, g: "green" }, { id: 32, name: "Marmaris Sk.", type: "property", color: "#228B22", price: 300, rent: [26, 130, 390, 900, 1100, 1275], hc: 200, g: "green" }, { id: 33, name: "Sandık", type: "chest" }, { id: 34, name: "Fethiye Blv.", type: "property", color: "#228B22", price: 320, rent: [28, 150, 450, 1000, 1200, 1400], hc: 200, g: "green" }, { id: 35, name: "İstanbul İst.", type: "railroad", price: 200, rent: [25, 50, 100, 200] }, { id: 36, name: "Şans", type: "chance" }, { id: 37, name: "Nişantaşı", type: "property", color: "#0000CD", price: 350, rent: [35, 175, 500, 1100, 1300, 1500], hc: 200, g: "darkblue" }, { id: 38, name: "Lüks Vergisi", type: "tax", amount: 100 }, { id: 39, name: "Bağdat Cd.", type: "property", color: "#0000CD", price: 400, rent: [50, 200, 600, 1400, 1700, 2000], hc: 200, g: "darkblue" }];
        const GR = { brown: [1, 3], lightblue: [6, 8, 9], pink: [11, 13, 14], orange: [16, 18, 19], red: [21, 23, 24], yellow: [26, 27, 29], green: [31, 32, 34], darkblue: [37, 39], railroad: [5, 15, 25, 35], utility: [12, 28] };
        let CHANCE = [{ t: "Başlangıca git, 200₺ al!", a: "goto", to: 0, c: 200 }, { t: "Haydarpaşa'ya git.", a: "goto", to: 5 }, { t: "3 kare geri.", a: "move", s: -3 }, { t: "Hapise git!", a: "jail" }, { t: "50₺ kazan!", a: "get", m: 50 }, { t: "15₺ ceza.", a: "pay", m: 15 }, { t: "150₺ kazan!", a: "get", m: 150 }, { t: "Tamir: Ev 25₺, Otel 100₺", a: "repair", h: 25, o: 100 }, { t: "Ücretsiz Hapisten Çıkış Kartı!", a: "jailfree" }];
        let CHEST = [{ t: "Başlangıca git, 200₺ al!", a: "goto", to: 0, c: 200 }, { t: "Banka hatası: 200₺!", a: "get", m: 200 }, { t: "Doktor: 50₺", a: "pay", m: 50 }, { t: "Hisse: 50₺", a: "get", m: 50 }, { t: "Hapise git!", a: "jail" }, { t: "Tatil: 100₺", a: "get", m: 100 }, { t: "Vergi iadesi: 20₺", a: "get", m: 20 }, { t: "Miras: 100₺", a: "get", m: 100 }, { t: "Ücretsiz Hapisten Çıkış Kartı!", a: "jailfree" }];

        const SND = {
            ctx: null,
            enabled: true,
            init() {
                if (!this.ctx) {
                    try { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); } catch (e) { }
                }
            },
            play(type) {
                if (!this.enabled) return;
                this.init();
                if (!this.ctx) return;
                const o = this.ctx.createOscillator();
                const g = this.ctx.createGain();
                o.connect(g); g.connect(this.ctx.destination);
                const now = this.ctx.currentTime;
                if (type === 'dice') {
                    o.type = 'square';
                    o.frequency.setValueAtTime(120, now);
                    o.frequency.exponentialRampToValueAtTime(10, now + 0.15);
                    g.gain.setValueAtTime(0.05, now);
                    g.gain.linearRampToValueAtTime(0, now + 0.15);
                    o.start(); o.stop(now + 0.15);
                } else if (type === 'coin') {
                    o.type = 'sine';
                    o.frequency.setValueAtTime(800, now);
                    o.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
                    g.gain.setValueAtTime(0.05, now);
                    g.gain.linearRampToValueAtTime(0, now + 0.15);
                    o.start(); o.stop(now + 0.15);
                } else if (type === 'buy') {
                    o.type = 'triangle';
                    o.frequency.setValueAtTime(400, now);
                    o.frequency.linearRampToValueAtTime(800, now + 0.4);
                    g.gain.setValueAtTime(0.05, now);
                    g.gain.linearRampToValueAtTime(0, now + 0.4);
                    o.start(); o.stop(now + 0.4);
                } else if (type === 'jail') {
                    o.type = 'sawtooth';
                    o.frequency.setValueAtTime(200, now);
                    o.frequency.linearRampToValueAtTime(50, now + 0.5);
                    g.gain.setValueAtTime(0.05, now);
                    g.gain.linearRampToValueAtTime(0, now + 0.5);
                    o.start(); o.stop(now + 0.5);
                }
            }
        };

        function toggleSoundEffect() {
            SND.enabled = !SND.enabled;
            const btn = document.getElementById('toggleSound');
            if (btn) btn.classList.toggle('on', SND.enabled);
            autoSave();
        }

        function spawnConfetti() {
            for (let i = 0; i < 40; i++) {
                const c = document.createElement('div');
                c.style.cssText = `position:fixed; width:8px; height:8px; background-color:${['#FFD700', '#C41E3A', '#2196F3', '#4CAF50', '#E91E63'][Math.floor(Math.random() * 5)]}; top:-10px; left:${Math.random() * 100}vw; z-index:9999; border-radius:1px;`;
                document.body.appendChild(c);
                const anim = c.animate([
                    { transform: `translateY(0) rotate(0deg)`, opacity: 1 },
                    { transform: `translateY(100vh) rotate(${Math.random() * 720}deg)`, opacity: 0 }
                ], { duration: 1500 + Math.random() * 2000, easing: 'cubic-bezier(0,.5,.5,1)' });
                anim.onfinish = () => c.remove();
            }
        }

        const COLORS = { red: '#f44336', blue: '#2196f3', green: '#4caf50', yellow: '#ffeb3b' };
        const TOKEN_ICONS = ['🚗', '🎩', '🐕', '🚢', '🦖', '👞', '🧺', '🐈'];
        const LANGS = {
            tr: {
                start: "OYUNA BAŞLA",
                resume: "ÖNCEKİ OYUNA DEVAM ET",
                roll: "ZAR AT",
                buy: "SATIN AL",
                auction: "İHALE",
                house: "EV",
                mortgage: "İPOTEK",
                trade: "TAKAS YAP",
                endTurn: "TURU BİTİR",
                thinking: "düşünüyor...",
                jail: "HAPİS",
                jailPay: "CEZA ÖDE",
                jailCard: "KART KULLAN",
                stats: "İSTATİSTİKLER",
                theme: "GÖRÜNÜM TEMASI",
                speed: "HIZ",
                sound: "SES EFEKTLERİ",
                lang: "DİL",
                earned: "Toplam Kazanç",
                rentPaid: "Ödenen Kira",
                rentReceived: "Alınan Kira",
                taxPaid: "Vergi/Ceza",
                jailTurns: "Hapiste Geçen",
                doubles: "Çift Atma",
                lands: "Basılan Kare",
                winner: "kazandı!",
                ai_tycoon: "Kodaman",
                ai_banker: "Bankacı",
                ai_opportunist: "Fırsatçı",
                human: "İnsan",
                set_break: "Setimi bozamam!",
                not_fair: "Teklifi yetersiz buldu."
            },
            en: {
                start: "START GAME",
                resume: "RESUME PREVIOUS GAME",
                roll: "ROLL DICE",
                buy: "BUY",
                auction: "AUCTION",
                house: "HOUSE",
                mortgage: "MORTGAGE",
                trade: "TRADE",
                endTurn: "END TURN",
                thinking: "thinking...",
                jail: "JAIL",
                jailPay: "PAY FINE",
                jailCard: "USE CARD",
                stats: "STATISTICS",
                theme: "APPEARANCE THEME",
                speed: "SPEED",
                sound: "SOUND EFFECTS",
                lang: "LANGUAGE",
                earned: "Total Earned",
                rentPaid: "Rent Paid",
                rentReceived: "Rent Received",
                taxPaid: "Tax/Fine",
                jailTurns: "Jail Turns",
                doubles: "Dice Doubles",
                lands: "Squares Landed",
                winner: "won!",
                ai_tycoon: "Tycoon",
                ai_banker: "Banker",
                ai_opportunist: "Opportunist",
                human: "Human",
                set_break: "I can't break my set!",
                not_fair: "Found the offer insufficient.",
                counter: "suggests a better price:"
            }
        };

        let currLang = 'tr';
        function t(key) { return LANGS[currLang][key] || key; }

        function toggleLang() {
            currLang = currLang === 'tr' ? 'en' : 'tr';
            document.getElementById('langLabel').textContent = currLang.toUpperCase();
            updateLangUI();
            autoSave();
        }

        function updateLangUI() {
            // Update setup screen
            const startBtn = document.querySelector('button[onclick="startGame()"]');
            if (startBtn) startBtn.textContent = t('start');
            const resBtn = document.getElementById('resumeBtn');
            if (resBtn) resBtn.textContent = t('resume');

            // Update game UI
            document.getElementById('rollBtn').innerHTML = `🎲 ${t('roll')}`;
            document.getElementById('buyBtn').innerHTML = `🏠 ${t('buy')}`;
            document.getElementById('auctionBtn').innerHTML = `🔨 ${t('auction')}`;
            document.getElementById('buildBtn').innerHTML = `🏗️ ${t('house')}`;
            const endBtn = document.getElementById('endBtn');
            if (endBtn) endBtn.innerHTML = `⏭️ ${t('endTurn')}`;

            // Labels in settings
            const settingsLabels = document.querySelectorAll('.ui-settings span');
            if (settingsLabels[0]) settingsLabels[0].textContent = t('theme');
            if (settingsLabels[1]) settingsLabels[1].textContent = t('sound');
            if (settingsLabels[2]) settingsLabels[2].textContent = t('lang');

            const speedLabel = document.querySelector('label[for="speedRange"]'); // if added
            // ... more mappings if needed
        }

        let G = { players: [], cur: 0, rolled: false, doubles: 0, park: 0, pending: null };
        let AUC = { on: false, prop: null, bid: 0, bidder: null, parts: [], idx: 0 };
        let TR = { my: [], their: [] };
        function shuffle(a) { for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[a[i], a[j]] = [a[j], a[i]] } return a }
        const MAPS = {
            istanbul: [
                { id: 0, name: "BAŞLA", type: "go" }, { id: 1, name: "Kasımpaşa", type: "property", color: "#8B4513", price: 60, rent: [2, 10, 30, 90, 160, 250], hc: 50, g: "brown" }, { id: 2, name: "Sandık", type: "chest" }, { id: 3, name: "Dolapdere", type: "property", color: "#8B4513", price: 60, rent: [4, 20, 60, 180, 320, 450], hc: 50, g: "brown" }, { id: 4, name: "Vergi", type: "tax", amount: 200 }, { id: 5, name: "Haydarpaşa", type: "railroad", price: 200, rent: [25, 50, 100, 200] },
                { id: 6, name: "Beşiktaş", type: "property", color: "#87CEEB", price: 100, rent: [6, 30, 90, 270, 400, 550], hc: 50, g: "lightblue" }, { id: 7, name: "Şans", type: "chance" }, { id: 8, name: "Ortaköy", type: "property", color: "#87CEEB", price: 100, rent: [6, 30, 90, 270, 400, 550], hc: 50, g: "lightblue" }, { id: 9, name: "Arnavutköy", type: "property", color: "#87CEEB", price: 120, rent: [8, 40, 100, 300, 450, 600], hc: 50, g: "lightblue" }, { id: 10, name: "HAPİS", type: "jail" },
                { id: 11, name: "Kadıköy", type: "property", color: "#FF69B4", price: 140, rent: [10, 50, 150, 450, 625, 750], hc: 100, g: "pink" }, { id: 12, name: "İSKİ", type: "utility", price: 150 }, { id: 13, name: "Moda", type: "property", color: "#FF69B4", price: 140, rent: [10, 50, 150, 450, 625, 750], hc: 100, g: "pink" }, { id: 14, name: "Fenerbahçe", type: "property", color: "#FF69B4", price: 160, rent: [12, 60, 180, 500, 700, 900], hc: 100, g: "pink" }, { id: 15, name: "Sirkeci", type: "railroad", price: 200, rent: [25, 50, 100, 200] },
                { id: 16, name: "Taksim", type: "property", color: "#FFA500", price: 180, rent: [14, 70, 200, 550, 750, 950], hc: 100, g: "orange" }, { id: 17, name: "Sandık", type: "chest" }, { id: 18, name: "Cihangir", type: "property", color: "#FFA500", price: 180, rent: [14, 70, 200, 550, 750, 950], hc: 100, g: "orange" }, { id: 19, name: "Galata", type: "property", color: "#FFA500", price: 200, rent: [16, 80, 220, 600, 800, 1000], hc: 100, g: "orange" }, { id: 20, name: "ÜCRETSİZ PARK", type: "parking" },
                { id: 21, name: "Şişli", type: "property", color: "#FF0000", price: 220, rent: [18, 90, 250, 700, 875, 1050], hc: 150, g: "red" }, { id: 22, name: "Şans", type: "chance" }, { id: 23, name: "Mecidiyeköy", type: "property", color: "#FF0000", price: 220, rent: [18, 90, 250, 700, 875, 1050], hc: 150, g: "red" }, { id: 24, name: "Levent", type: "property", color: "#FF0000", price: 240, rent: [20, 100, 300, 750, 925, 1100], hc: 150, g: "red" }, { id: 25, name: "Ankara İst.", type: "railroad", price: 200, rent: [25, 50, 100, 200] },
                { id: 26, name: "Üsküdar", type: "property", color: "#FFFF00", price: 260, rent: [22, 110, 330, 800, 975, 1150], hc: 150, g: "yellow" }, { id: 27, name: "Çengelköy", type: "property", color: "#FFFF00", price: 260, rent: [22, 110, 330, 800, 975, 1150], hc: 150, g: "yellow" }, { id: 28, name: "İGDAŞ", type: "utility", price: 150 }, { id: 29, name: "Beylerbeyi", type: "property", color: "#FFFF00", price: 280, rent: [24, 120, 360, 850, 1025, 1200], hc: 150, g: "yellow" }, { id: 30, name: "HAPİSE GİT", type: "gotojail" },
                { id: 31, name: "Bebek", type: "property", color: "#228B22", price: 300, rent: [26, 130, 390, 900, 1100, 1275], hc: 200, g: "green" }, { id: 32, name: "Etiler", type: "property", color: "#228B22", price: 300, rent: [26, 130, 390, 900, 1100, 1275], hc: 200, g: "green" }, { id: 33, name: "Sandık", type: "chest" }, { id: 34, name: "Yeniköy", type: "property", color: "#228B22", price: 320, rent: [28, 150, 450, 1000, 1200, 1400], hc: 200, g: "green" }, { id: 35, name: "İstanbul İst.", type: "railroad", price: 200, rent: [25, 50, 100, 200] },
                { id: 36, name: "Şans", type: "chance" }, { id: 37, name: "Nişantaşı", type: "property", color: "#0000CD", price: 350, rent: [35, 175, 500, 1100, 1300, 1500], hc: 200, g: "darkblue" }, { id: 38, name: "Lüks Vergisi", type: "tax", amount: 100 }, { id: 39, name: "Bağdat Cd.", type: "property", color: "#0000CD", price: 400, rent: [50, 200, 600, 1400, 1700, 2000], hc: 200, g: "darkblue" }
            ],
            turkiye: SQ, // Original SQ is now 'turkiye'
            world: [
                { id: 0, name: "START", type: "go" }, { id: 1, name: "Old Delhi", type: "property", color: "#8B4513", price: 60, rent: [2, 10, 30, 90, 160, 250], hc: 50, g: "brown" }, { id: 2, name: "Chest", type: "chest" }, { id: 3, name: "Jakarta", type: "property", color: "#8B4513", price: 60, rent: [4, 20, 60, 180, 320, 450], hc: 50, g: "brown" }, { id: 4, name: "Income Tax", type: "tax", amount: 200 }, { id: 5, name: "Reading RR", type: "railroad", price: 200, rent: [25, 50, 100, 200] },
                { id: 6, name: "Hong Kong", type: "property", color: "#87CEEB", price: 100, rent: [6, 30, 90, 270, 400, 550], hc: 50, g: "lightblue" }, { id: 7, name: "Chance", type: "chance" }, { id: 8, name: "Beijing", type: "property", color: "#87CEEB", price: 100, rent: [6, 30, 90, 270, 400, 550], hc: 50, g: "lightblue" }, { id: 9, name: "Shanghai", type: "property", color: "#87CEEB", price: 120, rent: [8, 40, 100, 300, 450, 600], hc: 50, g: "lightblue" }, { id: 10, name: "JAIL", type: "jail" },
                { id: 11, name: "Athens", type: "property", color: "#FF69B4", price: 140, rent: [10, 50, 150, 450, 625, 750], hc: 100, g: "pink" }, { id: 12, name: "Electric Co.", type: "utility", price: 150 }, { id: 13, name: "Rome", type: "property", color: "#FF69B4", price: 140, rent: [10, 50, 150, 450, 625, 750], hc: 100, g: "pink" }, { id: 14, name: "Madrid", type: "property", color: "#FF69B4", price: 160, rent: [12, 60, 180, 500, 700, 900], hc: 100, g: "pink" }, { id: 15, name: "Pennsylvania RR", type: "railroad", price: 200, rent: [25, 50, 100, 200] },
                { id: 16, name: "Berlin", type: "property", color: "#FFA500", price: 180, rent: [14, 70, 200, 550, 750, 950], hc: 100, g: "orange" }, { id: 17, name: "Chest", type: "chest" }, { id: 18, name: "Vienna", type: "property", color: "#FFA500", price: 180, rent: [14, 70, 200, 550, 750, 950], hc: 100, g: "orange" }, { id: 19, name: "Prague", type: "property", color: "#FFA500", price: 200, rent: [16, 80, 220, 600, 800, 1000], hc: 100, g: "orange" }, { id: 20, name: "FREE PARKING", type: "parking" },
                { id: 21, name: "Tokyo", type: "property", color: "#FF0000", price: 220, rent: [18, 90, 250, 700, 875, 1050], hc: 150, g: "red" }, { id: 22, name: "Chance", type: "chance" }, { id: 23, name: "Seoul", type: "property", color: "#FF0000", price: 220, rent: [18, 90, 250, 700, 875, 1050], hc: 150, g: "red" }, { id: 24, name: "Kyoto", type: "property", color: "#FF0000", price: 240, rent: [20, 100, 300, 750, 925, 1100], hc: 150, g: "red" }, { id: 25, name: "B. & O. RR", type: "railroad", price: 200, rent: [25, 50, 100, 200] },
                { id: 26, name: "Sydney", type: "property", color: "#FFFF00", price: 260, rent: [22, 110, 330, 800, 975, 1150], hc: 150, g: "yellow" }, { id: 27, name: "Melbourne", type: "property", color: "#FFFF00", price: 260, rent: [22, 110, 330, 800, 975, 1150], hc: 150, g: "yellow" }, { id: 28, name: "Water Works", type: "utility", price: 150 }, { id: 29, name: "Auckland", type: "property", color: "#FFFF00", price: 280, rent: [24, 120, 360, 850, 1025, 1200], hc: 150, g: "yellow" }, { id: 30, name: "GO TO JAIL", type: "gotojail" },
                { id: 31, name: "Rio de Janeiro", type: "property", color: "#228B22", price: 300, rent: [26, 130, 390, 900, 1100, 1275], hc: 200, g: "green" }, { id: 32, name: "Buenos Aires", type: "property", color: "#228B22", price: 300, rent: [26, 130, 390, 900, 1100, 1275], hc: 200, g: "green" }, { id: 33, name: "Chest", type: "chest" }, { id: 34, name: "Santiago", type: "property", color: "#228B22", price: 320, rent: [28, 150, 450, 1000, 1200, 1400], hc: 200, g: "green" }, { id: 35, name: "Short Line", type: "railroad", price: 200, rent: [25, 50, 100, 200] },
                { id: 36, name: "Chance", type: "chance" }, { id: 37, name: "London", type: "property", color: "#0000CD", price: 350, rent: [35, 175, 500, 1100, 1300, 1500], hc: 200, g: "darkblue" }, { id: 38, name: "Luxury Tax", type: "tax", amount: 100 }, { id: 39, name: "New York", type: "property", color: "#0000CD", price: 400, rent: [50, 200, 600, 1400, 1700, 2000], hc: 200, g: "darkblue" }
            ]
        };

        function getMapSQ(key) {
            return MAPS[key];
        }

        function startGame() {
            const mapKey = document.getElementById('mapSelect').value;
            window.activeSQ = getMapSQ(mapKey); // Globally accessible SQ for current game

            const configs = [
                { id: 1, name: document.getElementById('p1').value, type: document.getElementById('t1').value, color: 'red', icon: selectedIcons[1], pers: document.getElementById('pers1').value },
                { id: 2, name: document.getElementById('p2').value, type: document.getElementById('t2').value, color: 'blue', icon: selectedIcons[2], pers: document.getElementById('pers2').value },
                { id: 3, name: document.getElementById('p3').value, type: document.getElementById('t3').value, color: 'green', icon: selectedIcons[3], pers: document.getElementById('pers3').value },
                { id: 4, name: document.getElementById('p4').value, type: document.getElementById('t4').value, color: 'yellow', icon: selectedIcons[4], pers: document.getElementById('pers4').value }
            ];

            const activePlayers = configs.filter(c => c.type !== 'none' && c.name.trim() !== '');

            if (activePlayers.length < 2) { alert('En az 2 oyuncu gerekli!'); return; }

            G.customRules = {
                startMoney: parseInt(document.getElementById('ruleStartMoney').value) || 1500,
                salary: parseInt(document.getElementById('ruleSalary').value) || 200,
                parkingPool: document.getElementById('toggleParkPool').classList.contains('on'),
                randomStart: document.getElementById('toggleRandomStart').classList.contains('on'),
                challengeMode: document.getElementById('challengeMode').checked
            };

            // const availableIcons = shuffle([...TOKEN_ICONS]); // No longer needed, using selectedIcons
            G.players = activePlayers.map((c, i) => {
                const types = ['Tycoon', 'Banker', 'Opportunist'];
                let personality = 'Human';
                if (c.type.startsWith('ai')) {
                    personality = c.pers === 'Random' ? types[Math.floor(Math.random() * types.length)] : c.pers;
                }
                return {
                    id: i,
                    name: c.name.trim(),
                    color: c.color,
                    icon: c.icon,
                    money: G.customRules.startMoney,
                    pos: 0,
                    props: [],
                    jail: false,
                    jt: 0,
                    out: false,
                    isAI: c.type.startsWith('ai'),
                    difficulty: c.type.split('-')[1] || null,
                    personality: personality,
                    jailCards: 0,
                    stats: {
                        earned: G.customRules.startMoney,
                        rentPaid: 0,
                        rentReceived: 0,
                        jailTurns: 0,
                        doubles: 0,
                        taxPaid: 0,
                        lands: 0
                    }
                };
            });


            // Initialize customRules if missing property
            if (!G.customRules) G.customRules = { salary: 200, parkingPool: true };


            G.cur = 0;
            G.rolled = false;
            G.props = {};

            if (G.customRules.randomStart) {
                // Her oyuncuya 2-3 rastgele mülk dağıt (ilerlemeli mod için 3 daha dengeli)
                const pool = window.activeSQ.filter(s => ['property', 'railroad', 'utility'].includes(s.type)).map(s => s.id);
                shuffle(pool);
                G.players.forEach(p => {
                    for (let k = 0; k < 3; k++) {
                        const pid = pool.pop();
                        if (pid === undefined) break;
                        p.props.push(pid);
                        G.props[pid] = { owner: p.id, houses: 0, mort: false };
                    }
                });

                // Sadece tam sete sahip olanlara rastgele 1-2 ev ver (Monopol kurallarına uygun ilerleme)
                G.players.forEach(p => {
                    Object.entries(GR).forEach(([g, ids]) => {
                        if (g === 'railroad' || g === 'utility') return;
                        const ownsAll = ids.every(id => G.props[id] && G.props[id].owner === p.id);
                        if (ownsAll) {
                            const houseCount = Math.floor(Math.random() * 3); // 0, 1, 2 ev
                            ids.forEach(id => {
                                G.props[id].houses = houseCount;
                            });
                        }
                    });
                });
                log(`🎲 Rastgele mülkler dağıtıldı ve set tamamlayanlara evler verildi!`, true);
            }
            shuffle(CHANCE);
            shuffle(CHEST);

            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('gameContainer').style.display = 'flex';
            buildBoard();
            updateOwners(); // Random start mülklerini göster
            updateUI();
            log(`🎮 Oyun başladı!`, true);
            checkAI();
        }

        function checkAI() {
            if (document.querySelector('.modal-overlay.active')) {
                setTimeout(checkAI, 1000);
                return;
            }
            const p = G.players[G.cur];
            if (!p || p.out) { endTurn(); return; }
            if (p.isAI) {
                if (G.rolled) {
                    // AI already rolled but turn didn't end? Possible catch-up
                    setTimeout(aiPostTurn, 1000);
                    return;
                }
                log(`🤖 ${p.name} düşünüyor...`);
                setTimeout(() => playAITurn(p), 1500);
            }
        }




        function aiHandleProp(s) {
            const p = G.players[G.cur];
            const pool = p.money;
            const price = s.price;
            let shouldBuy = false;

            // AI Karar Mantığı + Kişilik Etkisi
            let safeMargin = 150;
            if (p.personality === 'Banker') safeMargin = 500;
            if (p.personality === 'Tycoon') safeMargin = 0;

            if (p.difficulty === 'easy') {
                shouldBuy = pool >= price && Math.random() > 0.5;
            } else if (p.difficulty === 'medium') {
                shouldBuy = pool >= price + safeMargin;
            } else if (p.difficulty === 'hard') {
                shouldBuy = pool >= price + (p.personality === 'Banker' ? 300 : -50);
            }


            if (shouldBuy) {
                buyProp();
            } else {
                startAuction();
            }
        }

        function playAITurn(p) {
            // New logic: AI rolls with a delay for realism
            if (p.jail) {
                const staySafe = p.difficulty === 'hard' && G.players.some(op => op.id !== p.id && op.props.some(pid => G.props[pid] && G.props[pid].houses > 0));

                // AI prioritize card then fine if rich
                if (p.jailCards > 0) {
                    useJailCard();
                    return;
                }

                if (p.money > 1000 && p.difficulty !== 'easy') {
                    payJail();
                    return;
                }

                if (p.difficulty === 'easy' || (p.difficulty === 'medium' && p.money < 1000) || staySafe) {
                    rollDice();
                } else {
                    if (p.money >= 50) {
                        payJail();
                    } else { rollDice(); }
                }
                return;
            }
            rollDice();
        }

        function updateSpeedDisp() {
            const v = document.getElementById('speedRange').value;
            const lbl = document.getElementById('speedVal');
            if (v >= 350) lbl.textContent = "ŞİMŞEK ⚡";
            else if (v >= 250) lbl.textContent = "Hızlı";
            else if (v >= 150) lbl.textContent = "Normal";
            else lbl.textContent = "Yavaş";
        }

        function getSpeed() {
            const v = parseInt(document.getElementById('speedRange').value) || 250;
            return 450 - v; // Invert: larger value = smaller delay = faster
        }

        function aiPostTurn() {
            const p = G.players[G.cur];
            const speed = getSpeed();

            // AI Mülk Geliştirme
            Object.entries(GR).forEach(([g, ids]) => {
                if (g === 'railroad' || g === 'utility') return;
                const all = ids.every(x => G.props[x] && G.props[x].owner === p.id && !G.props[x].mort);
                if (all) {
                    ids.forEach(x => {
                        const s = window.activeSQ[x], pr = G.props[x];
                        const limit = 5;
                        let margin = 300;
                        if (p.personality === 'Tycoon') margin = 100;
                        if (p.personality === 'Banker') margin = 700;

                        if (pr.houses < limit && p.money >= s.hc + margin) {
                            buildHouse(x);
                        }
                    });
                }
            });


            // AI Takas Başlatma Kontrolü (Sık olmasın)
            let tradePending = false;
            if (Math.random() < 0.2) {
                tradePending = aiInitiateTrade(p);
            }

            if (!tradePending) {
                setTimeout(endTurn, speed * 5);
            }
        }


        function openTradeOffer(sender, receiver, data) {
            const modal = document.getElementById('tradeOfferModal');
            document.getElementById('tradeOfferText').innerHTML = `<span style="color:${COLORS[sender.color]}">${sender.name}</span> <span style="opacity:0.6;">oyuncusu sana bir takas teklif etti!</span>`;

            const giverDiv = document.getElementById('tradeOfferGiver');
            const takerDiv = document.getElementById('tradeOfferTaker');

            const sMoney = data.myMoney > 0 ? `<div style="color:var(--gold); font-weight:800; margin-bottom:5px;">+${data.myMoney}₺</div>` : '';
            const rMoney = data.theirMoney > 0 ? `<div style="color:var(--gold); font-weight:800; margin-bottom:5px;">+${data.theirMoney}₺</div>` : '';

            const sProps = data.myProps.map(id => {
                const s = window.activeSQ[id];
                return `<div style="font-size:0.75rem; background:rgba(255,255,255,0.05); padding:5px 8px; border-radius:6px; margin-bottom:3px; display:flex; justify-content:space-between;">
                    <span>${s.name}</span> <span style="opacity:0.5;">(${s.price}₺)</span>
                </div>`;
            }).join('');

            const rProps = data.theirProps.map(id => {
                const s = window.activeSQ[id];
                return `<div style="font-size:0.75rem; background:rgba(255,255,255,0.05); padding:5px 8px; border-radius:6px; margin-bottom:3px; display:flex; justify-content:space-between;">
                    <span>${s.name}</span> <span style="opacity:0.5;">(${s.price}₺)</span>
                </div>`;
            }).join('');

            giverDiv.innerHTML = sMoney + (sProps || '<span style="opacity:0.3">Para/Eşya yok</span>');
            takerDiv.innerHTML = rMoney + (rProps || '<span style="opacity:0.3">Para/Eşya yok</span>');

            document.getElementById('acceptTradeBtn').onclick = () => {
                executeTrade(sender, receiver, data.myProps, data.theirProps, data.myMoney, data.theirMoney);
                closeModal('tradeOfferModal');
                if (sender.isAI && G.cur === sender.id) {
                    setTimeout(endTurn, 1000);
                }
            };
            document.getElementById('rejectTradeBtn').onclick = () => {
                log(`❌ ${receiver.name} teklifi reddetti.`);
                closeModal('tradeOfferModal');
                if (sender.isAI && G.cur === sender.id) {
                    setTimeout(endTurn, 1000);
                }
            };

            modal.classList.add('active');
        }


        function aiInitiateTrade(p) {
            for (const [g, ids] of Object.entries(GR)) {
                if (g === 'railroad' || g === 'utility') continue;
                const myCount = ids.filter(id => G.props[id] && G.props[id].owner === p.id).length;
                if (myCount > 0 && myCount < ids.length) {
                    const missing = ids.find(id => G.props[id] && G.props[id].owner !== null && G.props[id].owner !== p.id);
                    if (missing) {
                        const targetOwner = G.players[G.props[missing].owner];
                        if (targetOwner.out) continue;

                        const s = window.activeSQ[missing];
                        const offer = Math.floor(s.price * 1.5);
                        if (p.money > offer + 300) {
                            if (targetOwner.isAI) {
                                if (aiEvaluateTrade(p, targetOwner, { myProps: [], theirProps: [missing], myMoney: offer, theirMoney: 0 })) {
                                    executeTrade(p, targetOwner, [], [missing], offer, 0);
                                }
                            } else {
                                openTradeOffer(p, targetOwner, { myProps: [], theirProps: [missing], myMoney: offer, theirMoney: 0 });
                            }
                            return true; // Modal opened
                        }
                    }
                }
            }
            return false;
        }


        function aiEvaluateTrade(sender, receiver, data) {
            const sValue = data.myMoney + data.myProps.reduce((sum, id) => sum + (window.activeSQ[id].price || 0), 0);
            const rValue = data.theirMoney + data.theirProps.reduce((sum, id) => sum + (window.activeSQ[id].price || 0), 0);

            let threshold = 1.0;
            if (receiver.difficulty === 'easy') threshold = 0.7;
            if (receiver.difficulty === 'hard') threshold = 1.4;

            // AI'nın işine yarayacak bir mülk mü?
            let valuableToAI = data.myProps.some(id => {
                const s = window.activeSQ[id];
                const group = s.g || s.type; // Railroad/Utility için type'ı kullan
                if (!GR[group]) return false;
                return GR[group].some(gid => G.props[gid] && G.props[gid].owner === receiver.id);
            });

            if (valuableToAI) threshold -= 0.3;

            const isFair = sValue >= rValue * threshold;

            if (receiver.difficulty === 'hard' && !valuableToAI && data.theirProps.some(id => {
                const s = window.activeSQ[id];
                const group = s.g || s.type;
                if (!group || !GR[group]) return false;
                return GR[group].every(gid => G.props[gid] && G.props[gid].owner === receiver.id);
            })) {
                log(`❌ ${receiver.name}: "Setimi bozamam!"`);
                return false;
            }

            if (isFair) {
                log(`✅ ${receiver.name} takas teklifini kabul etti.`);
                return true;
            } else {
                // Counter-offer logic: If price is close (within 20%), suggest a slightly higher price
                if (data.myMoney > 0 && sValue >= rValue * threshold * 0.8 && !valuableToAI) {
                    const suggested = Math.floor(rValue * threshold * 1.1);
                    log(`🤔 ${receiver.name}: "${t('counter')} ${suggested}₺"`);
                } else {
                    log(`❌ ${receiver.name} ${t('not_fair')}`);
                }
                return false;
            }
        }

        function executeTrade(p, t, myProps, theirProps, myM, thM) {
            if (myM) chgMoney(p, -myM);
            if (thM) chgMoney(p, thM);
            if (myM) chgMoney(t, myM);
            if (thM) chgMoney(t, -thM);
            myProps.forEach(id => {
                p.props = p.props.filter(x => x !== id);
                t.props.push(id);
                G.props[id].owner = t.id;
            });
            theirProps.forEach(id => {
                t.props = t.props.filter(x => x !== id);
                p.props.push(id);
                G.props[id].owner = p.id;
            });
            log(`🔄 Takas başarıyla gerçekleşti!`, true);
            updateUI();
            updateOwners();
            autoSave();
        }


        function buildBoard() {
            const b = document.getElementById('board');
            b.innerHTML = '';

            // Re-insert center content
            const c = document.createElement('div');
            c.className = 'board-center';
            c.innerHTML = `
                <div class="center-logo" style="margin-bottom: 5px;" onclick="location.reload()">MONOPOLX</div>
                <div class="dice-container" id="diceContainer">
                    <div class="dice" id="d1" onclick="rollDice()"></div>
                    <div class="dice" id="d2" onclick="rollDice()"></div>
                </div>
            `;
            b.appendChild(c);

            window.activeSQ.forEach((s, i) => {
                const d = document.createElement('div');
                d.className = 'square'; d.id = 'sq-' + i;
                d.onclick = () => showProp(i);
                const p = getPos(i);
                d.style.gridColumn = p.c; d.style.gridRow = p.r;

                let h = '';
                if (s.type === 'property' || s.type === 'railroad' || s.type === 'utility') {
                    h = `<div class="color-bar" style="background:${s.color || '#333'}"></div><div class="buildings" id="bld-${i}"></div><div class="square-content"><div class="square-name">${s.name}</div><div class="square-price">${s.price}₺</div></div><div class="owner-bar" id="own-${i}"></div><div class="owner-info" id="own-info-${i}"></div>`;
                } else if (s.type === 'chance' || s.type === 'chest' || s.type === 'tax') {
                    const icon = s.type === 'chance' ? '❓' : (s.type === 'chest' ? '📦' : '💰');
                    h = `<div class="square-content ${s.type}"><div class="corner-icon">${icon}</div><div class="square-name">${s.name}</div>${s.amount ? `<div class="square-price">${s.amount}₺</div>` : ''}</div>`;
                } else {
                    const icons = { go: '➡️', jail: '🔒', parking: '🅿️', gotojail: '👮' };
                    h = `<div class="corner-icon">${icons[s.type] || ''}</div><div class="square-name">${s.name}</div>`;
                }

                d.innerHTML = h + '<div class="tokens-box" id="tok-' + i + '"></div>';

                // Add corner classes if applicable
                if (i === 0) d.classList.add('corner', 'corner-go');
                else if (i === 10) d.classList.add('corner', 'corner-jail');
                else if (i === 20) d.classList.add('corner', 'corner-parking');
                else if (i === 30) d.classList.add('corner', 'corner-gotojail');

                b.appendChild(d);
                if (G.props[i]) updateBld(i); // Başlangıç binalarını çiz
            });
            updateTokens();
        }
        function getPos(i) { if (i <= 10) return { r: 11, c: 11 - i }; if (i <= 19) return { r: 10 - (i - 11), c: 1 }; if (i <= 30) return { r: 1, c: i - 19 }; return { r: i - 29, c: 11 } }
        function sqHTML(s) {
            const ic = { go: '➡️', jail: '🔒', parking: '🅿️', gotojail: '👮', chance: '❓', chest: '📦', tax: '💰', railroad: '🚂' };
            if (['go', 'jail', 'parking', 'gotojail'].includes(s.type)) return `<div class="square-content"><div class="corner-icon">${ic[s.type]}</div><div class="square-name">${s.name}</div></div>`;
            if (s.type === 'property') return `<div class="color-bar" style="background:${s.color}"></div><div class="buildings" id="bld-${s.id}"></div><div class="square-content"><div class="square-name">${s.name}</div><div class="square-price">${s.price}₺</div></div><div class="owner-info" id="own-info-${s.id}"></div><div class="owner-bar" id="own-${s.id}"></div>`;
            if (s.type === 'utility') return `<div class="square-content"><div class="corner-icon">${s.name.includes('Elektrik') ? '💡' : '💧'}</div><div class="square-name">${s.name}</div><div class="square-price">${s.price}₺</div></div><div class="owner-info" id="own-info-${s.id}"></div><div class="owner-bar" id="own-${s.id}"></div>`;
            if (s.type === 'railroad') return `<div class="square-content"><div class="corner-icon">🚂</div><div class="square-name">${s.name}</div><div class="square-price">${s.price}₺</div></div><div class="owner-info" id="own-info-${s.id}"></div><div class="owner-bar" id="own-${s.id}"></div>`;
            if (s.type === 'tax') return `<div class="square-content"><div class="corner-icon">💰</div><div class="square-name">${s.name}</div><div class="square-price">${s.amount}₺</div></div>`;
            return `<div class="square-content"><div class="corner-icon">${ic[s.type] || '📋'}</div><div class="square-name">${s.name}</div></div>`
        }
        function dFace(v) { const p = { 1: [0, 0, 0, 0, 1, 0, 0, 0, 0], 2: [1, 0, 0, 0, 0, 0, 0, 0, 1], 3: [1, 0, 0, 0, 1, 0, 0, 0, 1], 4: [1, 0, 1, 0, 0, 0, 1, 0, 1], 5: [1, 0, 1, 0, 1, 0, 1, 0, 1], 6: [1, 0, 1, 1, 0, 1, 1, 0, 1] }; return p[v].map(x => `<div class="dot ${x ? 'active' : ''}"></div>`).join('') }
        function moneyAnim(pid, amt, pos) { const el = document.querySelector(`.player-card:nth-child(${pid + 1})`); if (!el) return; const r = el.getBoundingClientRect(); const f = document.createElement('div'); f.className = `money-float ${pos ? 'pos' : 'neg'}`; f.textContent = `${pos ? '+' : '-'}${Math.abs(amt)}₺`; f.style.left = r.left + r.width / 2 + 'px'; f.style.top = r.top + 'px'; document.body.appendChild(f); setTimeout(() => f.remove(), 800); const m = el.querySelector('.player-money'); if (m) { m.classList.remove('up', 'down'); void m.offsetWidth; m.classList.add(pos ? 'up' : 'down') } }
        function chgMoney(p, amt) {
            p.money += amt;
            moneyAnim(p.id, amt, amt > 0);
            if (amt !== 0) SND.play('coin');
        }

        function rollDice() {
            if (G.rolled) {
                console.log("Dice already rolled for this turn.");
                return;
            }
            if (document.querySelector('.modal-overlay.active')) return;

            const p = G.players[G.cur]; if (p.out) return;
            document.getElementById('rollBtn').disabled = true;
            document.getElementById('jailControls').style.display = 'none';
            const d1 = document.getElementById('d1'), d2 = document.getElementById('d2');
            SND.play('dice');
            d1.classList.add('rolling'); d2.classList.add('rolling');

            setTimeout(() => {
                let v1 = Math.floor(Math.random() * 6) + 1, v2 = Math.floor(Math.random() * 6) + 1;
                // Cheat for fast dice if rule on
                // if (G.customRules.fastDice && Math.random() < 0.3) { v1 = v2; } // fastDice rule removed
                d1.innerHTML = dFace(v1); d2.innerHTML = dFace(v2);
                d1.classList.remove('rolling'); d2.classList.remove('rolling');
                const dbl = v1 === v2, tot = v1 + v2;
                log(`🎲 ${p.name}: ${v1}+${v2}=${tot}${dbl ? ' ÇİFT!' : ''}`, dbl);
                if (p.jail) {
                    p.stats.jailTurns++;
                    if (dbl) { p.jail = false; p.jt = 0; log(`🔓 ${p.name} çift atarak çıktı!`, true); G.rolled = true; animMove(tot) }
                    else { p.jt++; if (p.jt >= 3) { chgMoney(p, -50, 'tax'); p.jail = false; p.jt = 0; log(`⚖️ ${p.name} 3 tur bekleyip 50₺ ödedi`); G.rolled = true; document.getElementById('endBtn').disabled = false; if (p.isAI) aiPostTurn(); } else { log(`🔒 Hapiste (${p.jt}/3)`); G.rolled = true; document.getElementById('endBtn').disabled = false; if (p.isAI) aiPostTurn(); } }
                } else {
                    if (dbl) {
                        p.stats.doubles++;
                        G.doubles++;
                        if (G.doubles >= 3) { log(`⚠️ ${p.name} 3 çift - HAPİS!`, true); goJail(); G.rolled = true; document.getElementById('endBtn').disabled = false; if (p.isAI) aiPostTurn(); return }
                    } else { G.doubles = 0; G.rolled = true }
                    animMove(tot)
                } updateUI()

            }, 500)
        }


        function payJail() {
            const p = G.players[G.cur];
            if (p.money >= 50) {
                chgMoney(p, -50);
                p.jail = false;
                p.jt = 0;
                log(`💸 ${p.name} 50₺ kefaletle çıktı`);
                document.getElementById('jailControls').style.display = 'none';
                rollDice();
            } else {
                alert("Yeterli paranız yok!");
            }
        }

        function useJailCard() {
            const p = G.players[G.cur];
            if (p.jailCards > 0) {
                p.jailCards--;
                p.jail = false;
                p.jt = 0;
                log(`🎫 ${p.name} kurtuluş kartını kullandı`);
                document.getElementById('jailControls').style.display = 'none';
                rollDice();
            }
        }
        function animMove(steps) {
            const p = G.players[G.cur];
            const totalSteps = Math.abs(steps);
            const direction = steps > 0 ? 1 : -1;

            // "Işık Hızı" modu için anında hareket
            if (document.getElementById('speedRange').value >= 350) {
                const oldPos = p.pos;
                p.pos = (p.pos + steps + 40) % 40;
                if (steps > 0 && p.pos < oldPos) {
                    const sal = G.customRules.salary;
                    chgMoney(p, sal);
                    log(`💰 ${p.name} +${sal}₺ maaş aldı`, true);
                }
                updateUI();
                handleLand(p.pos);
                return;
            }

            let currentStep = 0;
            function nextStep() {
                if (currentStep >= totalSteps) {
                    setTimeout(() => handleLand(p.pos), 300);
                    return;
                }

                currentStep++;
                p.pos = (p.pos + direction + 40) % 40;

                // Visual Jump Effect
                const b = document.getElementById('tok-' + p.pos);
                if (b) {
                    const jumpToken = document.createElement('div');
                    jumpToken.className = `token token-${p.color} jumping`;
                    jumpToken.innerHTML = p.icon;
                    b.appendChild(jumpToken);
                    setTimeout(() => jumpToken.remove(), 300);
                }

                if (direction > 0 && p.pos === 0) {
                    const sal = G.customRules.salary;
                    chgMoney(p, sal);
                    log(`💰 ${p.name} +${sal}₺ maaş aldı`, true);
                }

                updateUI();

                // Jump animation effect
                const token = document.querySelector(`.token-${p.color}`);
                if (token) {
                    token.style.transition = 'none';
                    token.animate([
                        { transform: 'translateY(0) scale(1)', offset: 0 },
                        { transform: 'translateY(-30px) scale(1.3)', offset: 0.5 },
                        { transform: 'translateY(0) scale(1)', offset: 1 }
                    ], { duration: getSpeed() * 1.5, easing: 'ease-out' });
                }

                setTimeout(nextStep, getSpeed() * 2);
            }
            nextStep();
        }

        function playRentAnim(fromId, toId, amount) {
            const fromCard = document.querySelector(`.player-card:nth-child(${fromId + 1})`);
            const toCard = document.querySelector(`.player-card:nth-child(${toId + 1})`);
            if (!fromCard || !toCard) return;

            const fromRect = fromCard.getBoundingClientRect();
            const toRect = toCard.getBoundingClientRect();

            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const m = document.createElement('div');
                    m.className = 'rent-money';
                    m.textContent = '💵';
                    m.style.left = (fromRect.left + fromRect.width / 2) + 'px';
                    m.style.top = (fromRect.top + fromRect.height / 2) + 'px';
                    m.style.setProperty('--target-x', (toRect.left + toRect.width / 2) + 'px');
                    m.style.setProperty('--target-y', (toRect.top + toRect.height / 2) + 'px');
                    document.body.appendChild(m);
                    setTimeout(() => m.remove(), 1000);
                }, i * 150);
            }
        }

        function handleLand(pos) {
            const s = window.activeSQ[pos], p = G.players[G.cur];
            document.querySelectorAll('.square').forEach(x => x.classList.remove('current'));
            document.getElementById('sq-' + pos).classList.add('current');
            if (['property', 'railroad', 'utility'].includes(s.type)) handleProp(s);
            else if (s.type === 'chance') drawCard(CHANCE, '❓ ŞANS', '❓');
            else if (s.type === 'chest') drawCard(CHEST, '📦 SANDIK', '📦');
            else if (s.type === 'tax') {
                if (p.money >= s.amount) {
                    chgMoney(p, -s.amount);
                    if (G.customRules.parkingPool) G.park += s.amount;
                    log(`💸 ${p.name} ${s.amount}₺ vergi ödedi`)
                } else bankrupt();
                document.getElementById('endBtn').disabled = false;
                if (p.isAI) aiPostTurn();
            } else if (s.type === 'gotojail') {
                goJail(); document.getElementById('endBtn').disabled = false; if (p.isAI) aiPostTurn();
            } else if (s.type === 'parking' && G.park > 0) {
                chgMoney(p, G.park); log(`🎉 ${p.name} ${G.park}₺ park ödülü aldı!`, true); G.park = 0;
                document.getElementById('endBtn').disabled = false; if (p.isAI) aiPostTurn();
            } else {
                document.getElementById('endBtn').disabled = false; if (p.isAI) aiPostTurn();
            }
            p.stats.lands++;
            updateUI();
        }

        function handleProp(s) {
            const p = G.players[G.cur], pr = G.props[s.id];
            if (!pr) {
                G.pending = s.id;
                if (p.money >= s.price) {
                    document.getElementById('buyBtn').disabled = false; document.getElementById('auctionBtn').disabled = false; document.getElementById('auctionBtn').style.display = 'inline-block'; log(`🏠 ${s.name} satılık: ${s.price}₺`); if (p.isAI) setTimeout(() => aiHandleProp(s), 1000);
                } else {
                    document.getElementById('auctionBtn').disabled = false; document.getElementById('auctionBtn').style.display = 'inline-block'; log(`⚠️ Para yetmiyor, açık arttırma?`); if (p.isAI) setTimeout(startAuction, 1000);
                }
                document.getElementById('endBtn').disabled = false
            } else if (pr.owner !== p.id) {
                const ow = G.players[pr.owner];
                if (!ow.out && !pr.mort) {
                    const r = calcRent(s, pr);
                    if (p.money >= r) {
                        chgMoney(p, -r, 'rent'); chgMoney(ow, r, 'rent');
                        playRentAnim(p.id, ow.id, r);
                        log(`💰 ${p.name} → ${ow.name}: ${r}₺ kira`);
                    } else bankrupt(ow.id)
                }
                document.getElementById('endBtn').disabled = false; if (p.isAI) aiPostTurn();

            } else {
                log(`🏠 Kendi mülkünün üzerindesin: ${s.name}`); document.getElementById('endBtn').disabled = false; updateBuildBtn(); if (p.isAI) aiPostTurn();
            }
        }
        function calcRent(s, pr) { const ow = G.players[pr.owner]; if (s.type === 'railroad') return s.rent[ow.props.filter(x => window.activeSQ[x].type === 'railroad').length - 1]; if (s.type === 'utility') { const c = ow.props.filter(x => window.activeSQ[x].type === 'utility').length; const d = Math.floor(Math.random() * 6) + 1 + Math.floor(Math.random() * 6) + 1; return c === 2 ? d * 10 : d * 4 } if (pr.houses === 5) return s.rent[5]; if (pr.houses > 0) return s.rent[pr.houses]; const g = GR[s.g]; const all = g.every(x => G.props[x] && G.props[x].owner === pr.owner); return all ? s.rent[0] * 2 : s.rent[0] }
        function buyProp() {
            const p = G.players[G.cur], s = window.activeSQ[G.pending];
            chgMoney(p, -s.price); p.props.push(s.id);
            G.props[s.id] = { owner: p.id, houses: 0, mort: false };
            log(`✅ ${p.name} ${s.name} aldı!`, true);
            SND.play('buy');
            spawnConfetti();
            document.getElementById('buyBtn').disabled = true;

            document.getElementById('auctionBtn').disabled = true;
            document.getElementById('auctionBtn').style.display = 'none';
            G.pending = null;
            updateOwners();
            updateBuildBtn();
            updateUI();
            if (p.isAI) aiPostTurn();
        }
        function startAuction() { const s = window.activeSQ[G.pending]; AUC = { on: true, prop: G.pending, bid: 0, bidder: null, parts: G.players.filter(x => !x.out).map(x => ({ ...x, pass: false })), idx: 0 }; document.getElementById('buyBtn').disabled = true; document.getElementById('auctionBtn').disabled = true; document.getElementById('auctionBtn').style.display = 'none'; updateAuc(); document.getElementById('auctionModal').classList.add('active'); log(`🔨 ${s.name} açık artırmada!`, true) }
        function updateAuc() {
            const s = window.activeSQ[AUC.prop]; document.getElementById('auctionProp').innerHTML = `<div style="display:inline-block;width:25px;height:40px;background:${s.color || '#999'};border-radius:5px;vertical-align:middle;margin-right:8px"></div><span style="font-weight:700">${s.name}</span>`; document.getElementById('auctionBid').textContent = AUC.bid > 0 ? AUC.bid + '₺' : 'Teklif yok'; document.getElementById('auctionInfo').textContent = AUC.bidder !== null ? `En yüksek: ${G.players[AUC.bidder].name}` : ''; const act = AUC.parts.filter(x => !x.pass); if (act.length <= 1 && AUC.bid > 0) { endAuc(); return } while (AUC.parts[AUC.idx].pass) AUC.idx = (AUC.idx + 1) % AUC.parts.length; const cur = AUC.parts[AUC.idx]; document.getElementById('auctionPlayers').innerHTML = AUC.parts.map((x, i) => `<div class="auction-player ${x.pass ? 'out' : ''} ${i === AUC.idx ? 'current' : ''}" style="border-color:${COLORS[x.color]}">${x.name}${x.pass ? ' ❌' : ''}<div style="font-size:0.75rem;opacity:0.7">${x.money}₺</div></div>`).join('');

            // AI Bidding Logic Hook
            if (cur.isAI && !cur.pass) {
                // Hide buttons for everyone while AI thinks
                document.getElementById('bidBtns').innerHTML = `<div style="color:var(--gold)">🤖 ${cur.name} düşünüyor...</div>`;
                setTimeout(() => aiBid(cur), 1000);
            } else {
                let btns = `<div style="margin-bottom:8px;color:var(--gold);font-weight:600">${cur.name} teklif veriyor</div>`;[10, 50, 100].forEach(a => { if (AUC.bid + a <= cur.money) btns += `<button class="bid-btn" onclick="placeBid(${a})">+${a}₺</button>` }); btns += `<button class="bid-btn pass" onclick="passBid()">❌ Çekil</button>`; document.getElementById('bidBtns').innerHTML = btns
            }
        }

        function aiBid(p) {
            const s = window.activeSQ[AUC.prop];
            const limit = p.difficulty === 'easy' ? s.price * 0.8 : (p.difficulty === 'medium' ? s.price * 1.1 : s.price * 1.5);
            const canBid = AUC.bid + 10 <= p.money && AUC.bid + 10 <= limit;

            if (canBid) {
                const bidAmt = p.difficulty === 'hard' ? 50 : 10;
                placeBid(bidAmt);
            } else {
                passBid();
            }
        }
        function placeBid(a) {
            const b = AUC.parts[AUC.idx];
            if (AUC.bid + a > b.money) return;
            AUC.bid += a;
            AUC.bidder = b.id;
            log(`💰 ${b.name}: ${AUC.bid}₺`);
            nextBidder()
        }
        function passBid() { const b = AUC.parts[AUC.idx]; b.pass = true; log(`❌ ${b.name} çekildi`); nextBidder() }
        function nextBidder() { const act = AUC.parts.filter(x => !x.pass); if (act.length <= 1) { endAuc(); return } do { AUC.idx = (AUC.idx + 1) % AUC.parts.length } while (AUC.parts[AUC.idx].pass); updateAuc() }
        function endAuc() {
            const s = window.activeSQ[AUC.prop]; if (AUC.bidder !== null && AUC.bid > 0) { const w = G.players[AUC.bidder]; chgMoney(w, -AUC.bid); w.props.push(s.id); G.props[s.id] = { owner: w.id, houses: 0, mort: false }; log(`🎉 ${w.name} ${s.name}'i ${AUC.bid}₺'ye aldı!`, true) } else log(`⚠️ ${s.name} satılmadı`); document.getElementById('auctionModal').classList.remove('active'); AUC.on = false; G.pending = null; updateUI(); updateOwners();
            if (G.players[G.cur].isAI) {
                aiPostTurn();
            }
        }
        function drawCard(deck, title, icon) {
            let c = deck.shift();
            deck.push(c);

            // Challenge Mode Logic
            if (G.customRules.challengeMode && Math.random() < 0.3) {
                const challenges = [
                    { t: "KAOS! Bir rakibinle piyon yerlerinizi takas edin!", a: "swap" },
                    { t: "İFLASIN EŞİĞİ! Nakit paranın yarısını kaybet!", a: "halve" },
                    { t: "MİLYARDER OL! Nakit paran ikiye katlansın!", a: "double" },
                    { t: "EMLAK KRİZİ! Rastgele bir mülkünü bankaya geri ver!", a: "lose_prop" },
                    { t: "PİYANGO! Diğer tüm oyunculardan 100₺ al!", a: "lottery" }
                ];
                c = challenges[Math.floor(Math.random() * challenges.length)];
                title = "🔥 CHALLENGE";
                icon = "🔥";
            }

            document.getElementById('cardTitle').textContent = title;
            document.getElementById('cardIcon').textContent = icon;
            document.getElementById('cardText').textContent = c.t;
            document.getElementById('cardModal').classList.add('active');
            const p = G.players[G.cur];

            if (c.a === 'get') {
                chgMoney(p, c.m);
                log(`💰 +${c.m}₺`);
            } else if (c.a === 'pay') {
                if (p.money >= c.m) {
                    chgMoney(p, -c.m);
                    G.park += c.m;
                    log(`💸 -${c.m}₺`);
                } else bankrupt();
            } else if (c.a === 'jailfree') {
                p.jailCards++;
                log(`🎫 Hapisten Çıkış Kartı alındı!`);
            } else if (c.a === 'goto') {
                setTimeout(() => {
                    closeModal('cardModal');
                    if (c.to < p.pos && c.c) chgMoney(p, c.c);
                    p.pos = c.to;
                    updateUI();
                    setTimeout(() => handleLand(c.to), 200);
                }, 1200);
                return;
            } else if (c.a === 'move') {
                setTimeout(() => {
                    closeModal('cardModal');
                    animMove(c.s);
                }, 1200);
                return;
            } else if (c.a === 'jail') {
                setTimeout(() => {
                    closeModal('cardModal');
                    goJail();
                    document.getElementById('endBtn').disabled = false;
                    if (p.isAI) aiPostTurn();
                }, 1200);
                return;
            } else if (c.a === 'repair') {
                let cost = 0;
                p.props.forEach(id => {
                    const pr = G.props[id];
                    if (pr && pr.houses > 0) cost += pr.houses === 5 ? c.o : pr.houses * c.h;
                });
                if (cost > 0) {
                    if (p.money >= cost) {
                        chgMoney(p, -cost);
                        G.park += cost;
                        log(`🔧 -${cost}₺ tamir`);
                    } else bankrupt();
                }
            } else if (c.a === 'swap') {
                const targets = G.players.filter(op => op.id !== p.id && !op.out);
                if (targets.length) {
                    const target = targets[Math.floor(Math.random() * targets.length)];
                    const oldPos = p.pos;
                    p.pos = target.pos;
                    target.pos = oldPos;
                    log(`🌀 ${p.name} ve ${target.name} yer değiştirdi!`, true);
                }
            } else if (c.a === 'halve') {
                chgMoney(p, -Math.floor(p.money / 2));
            } else if (c.a === 'double') {
                chgMoney(p, p.money);
            } else if (c.a === 'lose_prop') {
                if (p.props.length > 0) {
                    const rid = p.props[Math.floor(Math.random() * p.props.length)];
                    delete G.props[rid];
                    p.props = p.props.filter(pid => pid !== rid);
                    log(`🏚️ ${p.name}, ${window.activeSQ[rid].name} mülkünü kaybetti!`, true);
                    updateOwners();
                }
            } else if (c.a === 'lottery') {
                G.players.forEach(op => {
                    if (op.id !== p.id && !op.out) {
                        const amt = Math.min(op.money, 100);
                        chgMoney(op, -amt);
                        chgMoney(p, amt);
                    }
                });
            }
            document.getElementById('endBtn').disabled = false;
            updateUI();
            if (p.isAI) {
                setTimeout(() => closeModal('cardModal'), 1500);
                setTimeout(aiPostTurn, 1600);
            }
        }
        function goJail() { const p = G.players[G.cur]; p.pos = 10; p.jail = true; p.jt = 0; G.doubles = 0; log(`🔒 ${p.name} HAPİSTE!`, true); SND.play('jail'); updateUI() }

        function updateOwners() {
            window.activeSQ.forEach((s, i) => {
                const pr = G.props[i];
                const el = document.getElementById('own-' + i);
                const info = document.getElementById('own-info-' + i);
                const sq = document.getElementById('sq-' + i);
                if (el) {
                    if (pr) {
                        el.style.background = COLORS[G.players[pr.owner].color];
                        el.style.opacity = pr.mort ? '0.3' : '0.6';
                    } else {
                        el.style.background = '';
                        el.style.opacity = '1';
                    }
                }
                if (info) {
                    if (pr) {
                        info.textContent = G.players[pr.owner].name;
                        info.style.opacity = pr.mort ? '0.5' : '1';
                    } else {
                        info.textContent = '';
                    }
                }
                if (sq) {
                    if (pr) {
                        sq.classList.add('owned');
                        if (pr.mort) sq.style.filter = 'grayscale(0.5)';
                        else sq.style.filter = 'none';
                    } else {
                        sq.classList.remove('owned');
                        sq.style.filter = 'none';
                    }
                }
            });
        }
        function updateBuildBtn() {
            const p = G.players[G.cur];
            if (!p || p.isAI) return;
            let canBuildAnywhere = false;

            Object.entries(GR).forEach(([groupName, ids]) => {
                // Sadece arsa grubunda ev kurulabilir
                if (groupName === 'railroad' || groupName === 'utility') return;

                // Tüm gruba sahip mi ve hiçbiri ipotekli değil mi?
                const hasFullSet = ids.every(id => G.props[id] && G.props[id].owner === p.id && !G.props[id].mort);

                if (hasFullSet) {
                    ids.forEach(id => {
                        const sq = window.activeSQ[id];
                        const pr = G.props[id];
                        // Ev sayısı 5'ten az (otel olmamış) ve parası yetiyor mu?
                        if (pr.houses < 5 && p.money >= sq.hc) {
                            canBuildAnywhere = true;
                        }
                    });
                }
            });

            document.getElementById('buildBtn').disabled = !canBuildAnywhere;
        }
        function openBuild() {
            const p = G.players[G.cur];
            const c = document.getElementById('buildList');
            c.innerHTML = '';
            Object.entries(GR).forEach(([g, ids]) => {
                if (g === 'railroad' || g === 'utility') return;
                const all = ids.every(x => G.props[x] && G.props[x].owner === p.id && !G.props[x].mort);
                if (all) ids.forEach(x => {
                    const s = window.activeSQ[x], pr = G.props[x];
                    const limit = G.customRules.infHouses ? 99 : 5;
                    if (pr.houses < limit && p.money >= s.hc) {
                        const d = document.createElement('div');
                        d.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:10px;background:rgba(255,255,255,0.1);border-radius:8px;margin-bottom:8px';
                        let label = pr.houses === 4 ? 'Otel' : pr.houses + ' ev';
                        if (pr.houses >= 5) label = 'Gelişmiş';
                        d.innerHTML = `<span><span style="display:inline-block;width:15px;height:15px;background:${s.color};border-radius:3px;margin-right:8px"></span>${s.name} (${label})</span><button class="btn btn-action" style="padding:6px 12px;animation:none" onclick="buildHouse(${x})">🏗️ ${s.hc}₺</button>`;
                        c.appendChild(d)
                    }
                })
            });
            if (!c.innerHTML) c.innerHTML = '<p style="text-align:center;opacity:0.6;padding:15px">İnşa edilebilecek mülk yok</p>';
            document.getElementById('buildModal').classList.add('active')
        }

        function buildHouse(id) {
            const p = G.players[G.cur], s = window.activeSQ[id], pr = G.props[id];
            chgMoney(p, -s.hc);
            pr.houses++;
            log(`🏗️ ${p.name} ${s.name}'e ${pr.houses === 5 ? 'OTEL' : 'ev'} yaptı!`, true);
            updateBld(id);
            updateUI();
            openBuild();
        }
        function updateBld(id) { const pr = G.props[id]; if (!pr) return; const c = document.getElementById('bld-' + id); if (!c) return; c.innerHTML = ''; if (pr.houses === 5) c.innerHTML = '<div class="hotel"></div>'; else for (let i = 0; i < pr.houses; i++)c.innerHTML += '<div class="house"></div>' }
        function openMortgage() { const p = G.players[G.cur]; const c = document.getElementById('mortgageList'); c.innerHTML = ''; if (!p.props.length) { c.innerHTML = '<p style="text-align:center;opacity:0.6;padding:15px">Mülkün yok</p>'; document.getElementById('mortgageModal').classList.add('active'); return } p.props.forEach(id => { const s = window.activeSQ[id], pr = G.props[id], v = Math.floor(s.price / 2); const d = document.createElement('div'); d.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:10px;background:rgba(255,255,255,0.1);border-radius:8px;margin-bottom:8px'; if (pr.mort) { const cost = Math.floor(v * 1.1); d.innerHTML = `<span style="opacity:0.5"><span style="display:inline-block;width:15px;height:15px;background:${s.color || '#999'};border-radius:3px;margin-right:8px"></span>${s.name} (İPOTEKLİ)</span><button class="btn btn-action" style="padding:6px 12px;animation:none" onclick="unmort(${id})" ${p.money < cost ? 'disabled' : ''}>🔓 ${cost}₺</button>` } else if (pr.houses === 0) d.innerHTML = `<span><span style="display:inline-block;width:15px;height:15px;background:${s.color || '#999'};border-radius:3px;margin-right:8px"></span>${s.name}</span><button class="btn btn-end" style="padding:6px 12px" onclick="mort(${id})">💰 +${v}₺</button>`; else d.innerHTML = `<span><span style="display:inline-block;width:15px;height:15px;background:${s.color || '#999'};border-radius:3px;margin-right:8px"></span>${s.name} (${pr.houses} ev)</span><span style="opacity:0.5">Önce evleri sat</span>`; c.appendChild(d) }); document.getElementById('mortgageModal').classList.add('active') }
        function mort(id) { const p = G.players[G.cur], s = window.activeSQ[id], pr = G.props[id]; pr.mort = true; chgMoney(p, Math.floor(s.price / 2)); log(`💰 ${p.name} ${s.name} ipotek`); updateUI(); updateOwners(); openMortgage() }
        function unmort(id) { const p = G.players[G.cur], s = window.activeSQ[id], pr = G.props[id]; pr.mort = false; chgMoney(p, -Math.floor(s.price / 2 * 1.1)); log(`🔓 ${p.name} ${s.name} ipotekten çıkardı`); updateUI(); updateOwners(); openMortgage() }
        let lastTradePartner = null;
        function openTrade() {
            const p = G.players[G.cur];
            const sel = document.getElementById('tradePlayer');
            sel.innerHTML = '';
            let count = 0;
            G.players.forEach(x => {
                if (x.id !== p.id && !x.out) {
                    sel.innerHTML += `<option value="${x.id}">${x.name} (${x.money}₺)</option>`;
                    count++;
                }
            });
            if (count === 0) { alert('Takas yapılacak aktif başka oyuncu yok!'); return; }
            TR = { my: [], their: [] };
            lastTradePartner = parseInt(sel.value);
            document.getElementById('myMoney').value = '';
            document.getElementById('theirMoney').value = '';
            updateTrade();
            document.getElementById('tradeModal').classList.add('active')
        }
        function updateTrade() {
            const p = G.players[G.cur], tidVal = document.getElementById('tradePlayer').value;
            if (tidVal === "") return;
            const tid = parseInt(tidVal), t = G.players[tid];
            if (!t) return;

            // Partner değiştiyse karşı tarafın seçili mülklerini temizle
            if (lastTradePartner !== tid) {
                TR.their = [];
                lastTradePartner = tid;
            }

            const myC = document.getElementById('myProps');
            myC.innerHTML = '';
            if (!p.props.length) myC.innerHTML = '<span style="opacity:0.5">Mülk yok</span>';
            else p.props.forEach(id => {
                const s = window.activeSQ[id];
                const d = document.createElement('div');
                d.className = 'trade-prop' + (TR.my.includes(id) ? ' selected' : '');
                d.innerHTML = `<span style="display:inline-block;width:10px;height:10px;background:${s.color || '#999'};border-radius:2px;margin-right:5px"></span>${s.name}`;
                d.onclick = () => {
                    const i = TR.my.indexOf(id);
                    if (i > -1) TR.my.splice(i, 1);
                    else TR.my.push(id);
                    updateTrade();
                };
                myC.appendChild(d);
            });

            const thC = document.getElementById('theirProps');
            thC.innerHTML = '';
            if (!t.props.length) thC.innerHTML = '<span style="opacity:0.5">Mülk yok</span>';
            else t.props.forEach(id => {
                const s = window.activeSQ[id];
                const d = document.createElement('div');
                d.className = 'trade-prop' + (TR.their.includes(id) ? ' selected' : '');
                d.innerHTML = `<span style="display:inline-block;width:10px;height:10px;background:${s.color || '#999'};border-radius:2px;margin-right:5px"></span>${s.name}`;
                d.onclick = () => {
                    const i = TR.their.indexOf(id);
                    if (i > -1) TR.their.splice(i, 1);
                    else TR.their.push(id);
                    updateTrade();
                };
                thC.appendChild(d);
            });
        }
        function doTrade() {
            const p = G.players[G.cur], tid = parseInt(document.getElementById('tradePlayer').value), t = G.players[tid];
            const myM = parseInt(document.getElementById('myMoney').value) || 0, thM = parseInt(document.getElementById('theirMoney').value) || 0;
            if (!TR.my.length && !TR.their.length && !myM && !thM) { alert('Bir şey seç!'); return }
            if (myM > p.money || thM > t.money) { alert('Yeterli para yok!'); return }

            const tradeData = { myProps: [...TR.my], theirProps: [...TR.their], myMoney: myM, theirMoney: thM };

            if (t.isAI) {
                if (aiEvaluateTrade(p, t, tradeData)) {
                    executeTrade(p, t, TR.my, TR.their, myM, thM);
                    closeModal('tradeModal');
                } else {
                    alert(`${t.name} bu teklifi kabul etmedi.`);
                }
            } else {
                const myN = TR.my.map(x => window.activeSQ[x].name).join(', ') || 'Yok';
                const thN = TR.their.map(x => window.activeSQ[x].name).join(', ') || 'Yok';
                if (confirm(`${t.name} kabul etsin mi?\n\n📤 Sen: ${myN}${myM ? ' + ' + myM + '₺' : ''}\n📥 Karşılık: ${thN}${thM ? ' + ' + thM + '₺' : ''}`)) {
                    executeTrade(p, t, TR.my, TR.their, myM, thM);
                    closeModal('tradeModal');
                }
            }
        }

        function bankrupt(creditorId = null) {
            const p = G.players[G.cur];
            p.out = true;

            if (creditorId !== null) {
                const creditor = G.players[creditorId];
                log(`💀 ${p.name} iflas etti! Tüm varlıkları ${creditor.name} oyuncusuna devredildi.`, true);

                // Devret parayı
                if (p.money > 0) chgMoney(creditor, Math.max(0, p.money));

                // Devret mülkleri
                p.props.forEach(id => {
                    creditor.props.push(id);
                    G.props[id].owner = creditor.id;
                });

                // Devret hapis kartlarını
                creditor.jailCards += p.jailCards;
            } else {
                // Bankaya iflas
                p.props.forEach(id => {
                    delete G.props[id];
                    updateBld(id); // Reset houses/hotels on board
                });
                log(`💀 ${p.name} bankaya borcu yüzünden İFLAS etti!`, true);
            }

            p.props = [];
            p.money = 0;
            p.jailCards = 0;

            const act = G.players.filter(x => !x.out);
            if (act.length === 1) {
                document.getElementById('winText').textContent = `${act[0].name} ${act[0].money.toLocaleString('tr-TR')}₺ ile kazandı!`;
                document.getElementById('winModal').classList.add('active');
                spawnConfetti();
                setInterval(spawnConfetti, 2000);
            }

            updateOwners();
            updateUI();
        }
        function endTurn() {
            G.pending = null;
            G.rolled = false;
            G.doubles = 0;
            do { G.cur = (G.cur + 1) % G.players.length } while (G.players[G.cur].out);

            const p = G.players[G.cur];
            document.getElementById('rollBtn').disabled = false;
            document.getElementById('buyBtn').disabled = true;
            document.getElementById('auctionBtn').disabled = true;
            document.getElementById('auctionBtn').style.display = 'none';
            document.getElementById('buildBtn').disabled = true;
            document.getElementById('endBtn').disabled = true;

            // Show jail controls if in jail
            const jc = document.getElementById('jailControls');
            if (p.jail) {
                jc.style.display = 'flex';
                document.getElementById('useJailCardBtn').disabled = (p.jailCards <= 0);
            } else {
                jc.style.display = 'none';
            }

            document.querySelectorAll('.square').forEach(x => x.classList.remove('current'));
            log(`▶️ ${G.players[G.cur].name}'ın sırası!`, true);
            updateUI();
            autoSave();
            checkAI();
        }

        function autoSave() {
            try {
                const themeMatch = document.body.className.match(/theme-([a-z]+)/);
                const data = {
                    G: G,
                    CHANCE: CHANCE,
                    CHEST: CHEST,
                    mapKey: document.getElementById('mapSelect') ? document.getElementById('mapSelect').value : 'turkiye',
                    gameLog: document.getElementById('gameLog').innerHTML,
                    selectedIcons: selectedIcons,
                    theme: themeMatch ? themeMatch[1] : 'premium',
                    sound: SND.enabled,
                    lang: currLang
                };

                localStorage.setItem('monopolx_autosave', JSON.stringify(data));
            } catch (e) { console.error("AutoSave failed", e); }
        }

        function loadGame() {
            try {
                const raw = localStorage.getItem('monopolx_autosave');
                if (!raw) return;
                const data = JSON.parse(raw);
                G = data.G;
                CHANCE = data.CHANCE;
                CHEST = data.CHEST;

                if (data.lang) {
                    currLang = data.lang;
                    const lLbl = document.getElementById('langLabel');
                    if (lLbl) lLbl.textContent = currLang.toUpperCase();
                    updateLangUI();
                }

                if (data.sound !== undefined) {
                    SND.enabled = data.sound;
                    const btn = document.getElementById('toggleSound');
                    if (btn) btn.classList.toggle('on', SND.enabled);
                }


                if (data.selectedIcons) {
                    Object.assign(selectedIcons, data.selectedIcons);
                    for (let i = 1; i <= 4; i++) {
                        const preview = document.getElementById(`preview-p${i}`);
                        if (preview) preview.textContent = selectedIcons[i];
                    }
                }

                if (data.theme) setTheme(data.theme);

                const mapK = data.mapKey || 'turkiye';
                window.activeSQ = getMapSQ(mapK);
                if (document.getElementById('mapSelect')) document.getElementById('mapSelect').value = mapK;

                document.getElementById('setupScreen').classList.add('hidden');
                document.getElementById('gameContainer').style.display = 'flex';
                buildBoard();
                document.getElementById('gameLog').innerHTML = data.gameLog || "";
                updateOwners();
                updateUI();
                log("🎮 Oyun kaldığı yerden devam ediyor!", true);
                if (G.players[G.cur] && G.players[G.cur].isAI && !G.rolled) {
                    checkAI();
                }
            } catch (e) {
                console.error("Load failed", e);
                alert("Kayıt dosyası yüklenirken hata oluştu. Lütfen konsolu kontrol edin.");
            }
        }

        window.onload = () => {
            if (localStorage.getItem('monopolx_autosave')) {
                document.getElementById('resumeBtn').style.display = 'block';
            }
        }

        function updateUI() {
            updateTokens();
            updatePanel();
            const d = document.getElementById('parkDisp');
            if (d) d.innerHTML = G.park > 0 ? `🅿️ Park: <b>${G.park}₺</b>` : '';
            Object.keys(G.props).forEach(id => updateBld(parseInt(id)));

            const p = G.players[G.cur];
            const ctrl = document.querySelector('.controls-vertical');
            const turnName = document.getElementById('currentPlayerName');

            if (p) {
                if (turnName) {
                    turnName.textContent = p.isAI ? `🤖 ${p.name}` : `👤 ${p.name}`;
                    turnName.style.color = COLORS[p.color];
                }

                const aiOverlay = document.getElementById('aiOverlay');
                const aiWaitName = document.getElementById('aiWaitingPlayerName');

                if (ctrl) {
                    if (p.isAI) {
                        ctrl.style.opacity = '0.7';
                        ctrl.style.pointerEvents = 'none';
                        if (aiOverlay) aiOverlay.classList.add('active');
                        if (aiWaitName) aiWaitName.textContent = p.name;
                    } else {
                        ctrl.style.opacity = '1';
                        ctrl.style.pointerEvents = 'auto';
                        if (aiOverlay) aiOverlay.classList.remove('active');
                    }
                }

                // Sync Mobile Header & Bottom Bar
                if (window.innerWidth <= 900) {
                    const mobName = document.getElementById('mobCurrentName');
                    const mobMoney = document.getElementById('mobCurrentMoney');
                    const mobIcon = document.getElementById('mobCurrentIcon');
                    if (mobName) mobName.textContent = p.name;
                    if (mobMoney) mobMoney.textContent = p.money.toLocaleString() + '₺';
                    if (mobIcon) mobIcon.textContent = p.icon;

                    const mobRoll = document.getElementById('mobRollBtn');
                    const mobBuy = document.getElementById('mobBuyBtn');
                    const mobEnd = document.getElementById('mobEndBtn');

                    if (mobRoll) mobRoll.disabled = G.rolled || p.isAI;
                    if (mobBuy) mobBuy.disabled = document.getElementById('buyBtn').disabled;
                    if (mobEnd) mobEnd.disabled = document.getElementById('endBtn').disabled;
                }
            }
        }
        function updateTokens() {
            document.querySelectorAll('.tokens-box').forEach(b => b.innerHTML = '');
            G.players.forEach(p => {
                if (p.out) return;
                const b = document.getElementById('tok-' + p.pos);
                if (b) {
                    const t = document.createElement('div');
                    const isActive = G.players[G.cur].id === p.id;
                    t.className = `token token-${p.color}` + (isActive ? ' active-token' : '');
                    t.innerHTML = p.icon;
                    t.title = p.name;
                    b.appendChild(t);
                }
            });

            // Sırası olan oyuncunun karesini vurgula
            document.querySelectorAll('.square').forEach(s => s.classList.remove('current-active'));
            const curP = G.players[G.cur];
            const curSq = document.getElementById('sq-' + curP.pos);
            if (curSq) curSq.classList.add('current-active');
        }
        function updatePanel() { const pn = document.getElementById('playersPanel'); pn.innerHTML = ''; G.players.forEach((p, i) => { const c = document.createElement('div'); c.className = 'player-card' + (i === G.cur ? ' active' : '') + (p.out ? ' bankrupt' : ''); const dots = p.props.map(id => { const s = window.activeSQ[id], pr = G.props[id]; return `<div class="prop-dot" style="background:${s.color || (s.type === 'railroad' ? '#333' : '#9c27b0')};${pr && pr.mort ? 'opacity:0.4' : ''}" title="${s.name}"></div>` }).join(''); c.innerHTML = `<div class="player-header"><div class="player-token-icon token-${p.color}"></div><div><div class="player-name">${p.name}${p.isAI ? `<span class="ai-badge">${p.difficulty}</span>` : ''}${i === G.cur ? ' 🎯' : ''}</div><div class="player-money">${p.money.toLocaleString('tr-TR')}₺</div></div></div>${p.jail ? `<div style="color:#ff9800;font-size:0.75rem">🔒 Hapiste (${p.jt}/3)</div>` : ''}<div class="player-props">${dots || '<span style="opacity:0.4;font-size:0.7rem">Mülk yok</span>'}</div>`; pn.appendChild(c) }) }
        function showProp(i) { const s = window.activeSQ[i]; if (!['property', 'railroad', 'utility'].includes(s.type)) return; const pr = G.props[i]; let own = 'Satılık'; if (pr) { const o = G.players[pr.owner]; own = `<span style="color:${COLORS[o.color]}">${o.name}</span>${pr.mort ? ' <span style="color:#f44336">(İpotekli)</span>' : ''}` } document.getElementById('propInfo').innerHTML = `<div style="display:flex;align-items:center;gap:12px;margin-bottom:15px"><div style="width:35px;height:55px;background:${s.color || '#999'};border-radius:6px"></div><div><h3 style="margin:0">${s.name}</h3><p style="margin:4px 0 0;opacity:0.7">Sahibi: ${own}</p></div></div>`; let det = `<p><span>💰 Fiyat:</span><span>${s.price}₺</span></p>`; if (s.type === 'property') { det += `<p><span>Boş kira:</span><span>${s.rent[0]}₺</span></p>`; for (let h = 1; h <= 4; h++)det += `<p><span>${h} Ev:</span><span>${s.rent[h]}₺</span></p>`; det += `<p><span>🏨 Otel:</span><span>${s.rent[5]}₺</span></p><p><span>Ev maliyeti:</span><span>${s.hc}₺</span></p>`; if (pr && pr.houses > 0) det += `<p style="color:var(--gold)"><span>Mevcut:</span><span>${pr.houses === 5 ? '1 Otel' : pr.houses + ' Ev'}</span></p>` } else if (s.type === 'railroad') { for (let r = 1; r <= 4; r++)det += `<p><span>${r} İstasyon:</span><span>${s.rent[r - 1]}₺</span></p>` } else det += `<p><span>1 Şirket:</span><span>Zar×4</span></p><p><span>2 Şirket:</span><span>Zar×10</span></p>`; det += `<p><span>İpotek:</span><span>${Math.floor(s.price / 2)}₺</span></p>`; document.getElementById('propDetails').innerHTML = det; document.getElementById('propModal').classList.add('active') }
        function closeModal(id) { document.getElementById(id).classList.remove('active') }
        function log(m, imp = false) { const l = document.getElementById('gameLog'); const e = document.createElement('div'); e.className = 'log-entry' + (imp ? ' important' : ''); e.textContent = m; l.insertBefore(e, l.firstChild); while (l.children.length > 40) l.removeChild(l.lastChild) }

        // Keyboard Shortcuts
        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                // Focuslanan bir input varsa space tuşunu engelleme (yazı yazılabilsin)
                if (['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement.tagName)) return;

                e.preventDefault(); // Sayfa kaymasını engelle

                const rollBtn = document.getElementById('rollBtn');
                const endBtn = document.getElementById('endBtn');

                if (rollBtn && !rollBtn.disabled && rollBtn.offsetParent !== null) {
                    rollDice();
                } else if (endBtn && !endBtn.disabled && endBtn.offsetParent !== null) {
                    endTurn();
                }
            }
        });
        // Initialize setup screen UI
        window.addEventListener('load', () => {
            initIconSelectors();
            setTheme('parchment');
            autoName(3); autoName(4); // Trigger opacity update for inactive players
        });
    </script>
</body>

</html>